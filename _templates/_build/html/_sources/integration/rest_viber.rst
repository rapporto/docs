Viber
==============================


Поддерживаются следующие варианты Viber-сообщений:

*  только текст (в InstantContent задаётся атрибут type = TEXT);

*  только изображение (в InstantContent задаётся атрибут type = IMAGE_URL);

*  текст, кнопка для перехода (в InstantContent задаётся атрибут type = BUTTON с текстом, наименованием кнопки и URL для перехода);

*  текст, изображение, кнопка для перехода (в InstantContent задаётся атрибут type = BUTTON с текстом сообщения, адресом изображения, наименованием кнопки и URL для перехода).


Viber-сессии
--------------

Viber-сессии – функционал, позволяющий общаться с подписчиками по фиксированной цене за одну сессию в определенных временных рамках. При этом взимается абонентская плата за использование сессий и отдельно –оплачивается каждая сессия. Сообщения внутри сессий никак не тарифицируются.

.. note:: *Функционал Viber-сессий недоступен по умолчанию. Для его подключения обратитесь к своему курирующему менеджеру.*

Для бизнес-аккаунтов, поддерживающих функционал **Viber-сессий**, доступны сообщения с типом “только текст“ или “только изображение“ (параметр InstantContent.type должен быть либо “TEXT“, либо
“IMAGE_URL“). Сообщения с другим типом возвращают ошибку 400 “Invalid request“.

Подробнее о работе функционала в документе :doc:`./viber_sessions`

Параметры запроса для отправки сообщения
----------------------------------------


.. csv-table:: Параметры для отправки сообщения
   :header: "Параметр", "Тип данных", "Описание"
   :widths: 30, 15, 30
   :class: my-table


   "login", "string", "Имя Партнёра."
   "password", "string", "Пароль Партнёра для отправки сообщений."
   "destAddr", "string", "Номер телефона абонента. Содержит код страны, код оператора и номер телефона. Для РФ код может быть '8', '7' или '+7'"
   "message", "object", "Параметры отправляемого сообщения."
   "message/type", "enum", "Тип сообщения. Передается значение *Viber*"
   "message/data", "string", "Параметры отправляемых данных."
   "message/data/text", "string", "Текст отправляемого сообщения, максимальный размер для Viber не более 2000 символов;"
   "message/data/serviceNumber", "string", "Сервисное имя, от которого осуществляется отправка сообщения."
   "message/data/ttl", "string", "Срок жизни сообщения. Для Viber срок жизни может быть от 1 до 2880 минут;"
   "message/data/ttlUnit", "string", "Единица измерения периода доставки сообщения. Допустимые значения: SECONDS, MINUTES (значение по-умолчанию), HOURS. Передается только дополнительно к ttl. Необязательный параметр"



Дополнительные параметры для Viber-сообщений
--------------------------------------------------------

Для Viber-сообщений есть возможность отправки дополнительных параметров в виде изображений, кнопок и так далее. Данные передаются в параметрах **message/data/instantContent**.


Передаваемые параметры Viber-сообщения
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

+---------------------------------+---------+----------------------------+
| **Атрибут**                     | **Тип** | **Описание**               |
+---------------------------------+---------+----------------------------+
| InstantContent/type             | enum    | Тип параметра сообщения.   |
|                                 |         |                            |
|                                 |         | Может принимать одно из    |
|                                 |         | перечисленных значений –   |
|                                 |         | TEXT, IMAGE_URL.           |
+---------------------------------+---------+----------------------------+
| InstantContent/data             | object  | Параметры отправляемых     |
|                                 |         | данных.                    |
+---------------------------------+---------+----------------------------+
| InstantContent/data/text        | string  | Текст сообщения.           |
|                                 |         |                            |
|                                 |         | Максимальная длина – 1000  |
|                                 |         | символов.                  |
+---------------------------------+---------+----------------------------+
| InstantContent/data/imageURL    | string  | Url-адрес изображения для  |
|                                 |         | передачи.                  |
|                                 |         |                            |
|                                 |         | Рекомендовано использовать |
|                                 |         | изображение размером       |
|                                 |         | 400x400px с расширением    |
|                                 |         | JPG или PNG.               |
+---------------------------------+---------+----------------------------+




Пример отправки Viber-сообщения
----------------------------------------


.. code-block:: json

    {
       "login":"ВАШ_ЛОГИН",
       "password":"ВАШ_ПАРОЛЬ",
       "useTimeDiff":false,
       "id":"8770100",
       "scheduleInfo":
       {
          "timeBegin":"10:00",
          "timeEnd":"20:00",
          "weekdaysSchedule":"12345"
       },
       "destAddr":"Номер_Абонента",
       "message":
       {
          "type":"VIBER",
          "data":
          {
             "instantContent":
             {
                "type":"TEXT",
                "data":
                {
                   "text":"VIBERMESS"
                }
             },
             "serviceNumber":"НОМЕР_ОТПРАВИТЕЛЯ",
             "ttl":1
          }
       }
    }





Дополнительные вариации отправки Viber можно посмотреть в разделе подробнее в документе :doc:`rest_examples`

Ответ на запрос отправки сообщения
----------------------------------

После отправки сообщения Сервис-провайдер синхронно возвращает ответ. В случае успешной отправки возвращается http-code 200 OK. Для ошибочных результатов http-код ответа будет отличный от 200.
Успешный результат отправки

В случае успешной отправки возвращается ответ с параметром **mtNum** в котором передается идентификатор сообщения, который присваивается ему Платформой при получении.

.. code-block:: json

    {
        "mtNum": "7390612217"
    }




Ошибки отправки Viber-сообщений 
---------------------------------

Параметры 
~~~~~~~~~~

В случае ошибки возвращается ответное сообщение со следующими параметрами:

.. csv-table:: Параметры сообщения об ошибке
   :header: "Параметр", "Тип данных", "Описание"
   :widths: 30, 15, 30
   :class: my-table


   "error", "object", "Информация об ошибке"
   "error/code", "int", "Код ошибки"
   "error/description", "string", "Краткое описание ошибки"
   "extendedDescription", "string", "Подробное описание ошибки (не обязательный параметр)"



Пример ошибки отправки для Viber-сообщения
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

.. code-block:: json

   {
       "error": {
           "code": 4,
           "description": "Invalid request"
       },
       "extendedDescription": "Message is too long (2618 symbols). Viber message max length is 2000 symbols."
   }



Коды ошибок отправки
~~~~~~~~~~~~~~~~~~~~


.. csv-table:: Причины недоставки сообщений Viber
   :header: "Код", "Описание", "HTTP-код"
   :widths: 7, 30, 15
   :class: my-table


   1, "Service is unavailable", "503"
   2, "Invalid IP-address", "403"
   3, "Too many connections", "429"
   4, "Invalid request", "400"
   5, "Invalid login", "401"
   6, "Invalid password", "401"
   7, "serviceNumber is not defined", "400"
   8, "destAddr is not correct", "406"
   9, "Message type is not correct", "406"
   10, "Prohibited sending duplicates", "409"
   11, "Invalid TTL", "406"
   100, "100", "500"
   




MO-сообщение
============

На настроенный URL Партнёра передаётся MO-сообщение (сообщение от абонента в сторону Партнёра) в следующем формате:


.. csv-table:: Параметры MO-сообщений
   :header: "Параметр", "Тип", "Описание"
   :widths: 30, 15, 30
   :class: my-table


   "transactionId", "string", "Идентификатор транзакции, созданный системой Сервис-Провайдера."
   "destAddr", "string", "Сервисный номер, на который абонент отправил сообщение."
   "sourceAddr", "string", "Номер абонента."
   "type", "string", "Тип сообщения."
   "message", "string", "Текст сообщения Партнёру от абонента. если МО-сообщение не содержит текст сообщения, то параметр message в JSON должен отсутствовать."
   "partCount", "integer", "Количество частей сообщения."
   "receivedDate", "string", "Дата получения данного MO-сообщения от абонента."
   "mediaURL", "string", "Ссылка на изображение. Параметр необязательный, если вложение отсутствует."
   


Пример МО для Viber:

.. code-block:: json

    { 
      "transactionId": "20190418175651967013", 
      "destAddr": "0000", 
      "sourceAddr": "72101234567", 
      "type": "Viber", 
      "message": "Сообщение для партнёра", 
      "partCount": 1,
      "receivedDate": "2022-06-22T10:22:45+0300" 
    }




Причины недоставки сообщений
----------------------------

Если сообщение успешно принято к отправки, то для получения статусов сообщения необходимо настроить получение статусов, подробнее в документе :doc:`rest_status`

Параметр errorCode при успешном выполнении отправки равен 0. При status = 5 возвращает код ошибки.


Причины недоставки в Viber:


+---------+------------------------------+----------------------------+
| **Код** | **Сообщение об ошибке**      | **Описание ошибки**        |
+---------+------------------------------+----------------------------+
| 1       | unknown                      | В процессе доставки        |
|         |                              | сообщения произошла        |
|         |                              | неизвестная платформе      |
|         |                              | ошибка, либо оператор не   |
|         |                              | предоставил ошибку в       |
|         |                              | отчете о доставке.         |
+---------+------------------------------+----------------------------+
| 3       | call-barred                  | Аппарат абонента           |
|         |                              | заблокирован, либо у       |
|         |                              | абонента включен запрет на |
|         |                              | прием сообщений, либо      |
|         |                              | абонент находится в        |
|         |                              | роуминге с включенным      |
|         |                              | запретом на прием          |
|         |                              | сообщений в роуминге.      |
+---------+------------------------------+----------------------------+
| 5       | memory-capacity-exceeded     | Память телефона абонента   |
|         |                              | переполнена.               |
+---------+------------------------------+----------------------------+
| 6       | teleservice-not-provisioned  | У абонента не подключена   |
|         |                              | услуга приема сообщений.   |
+---------+------------------------------+----------------------------+
| 7       | timeout                      | Коммутационное             |
|         |                              | оборудование, на котором   |
|         |                              | зарегистрирован абонент,   |
|         |                              | не отвечает.               |
+---------+------------------------------+----------------------------+
| 9       | duplicated                   | Сообщение было отброшено   |
|         |                              | платформой, так как        |
|         |                              | сработал механизмом        |
|         |                              | отсечения дубликатов       |
|         |                              | сообщений.                 |
+---------+------------------------------+----------------------------+
| 11      | unrouted                     | Ошибка маршрутизации в     |
|         |                              | конфигурации платформы.    |
+---------+------------------------------+----------------------------+



