

Запрос на отправку SMS
=========================

Примеры запросов
-----------------

.. tabs::

    .. tab:: Пример запроса

        .. code-block:: json
           :linenos:

            { 
                "messages": [ 
                    { 
                        "from": "MyCompany",
                        "to": "79034567890",
                        "text": "Code: 1234"
                    },
                    { 
                        "from": "TAXI", 
                        "to": " 89034567890", 
                        "text": "Code: 1234"
                    }
                ]
            }

    .. tab:: Пример расширенного запроса

        .. note:: Значения параметров *scheduleInfo* и *useTimeDiff* применяются для всего переданного пакета SMS-сообщений.

        .. code-block:: json
           :linenos:

            {
            "useTimeDiff": true,
            "scheduleInfo": {
                "timeBegin": "10:00",
                "timeEnd": "12:00",
                "weekdaysSchedule": "123",
                "deadline": "2024-08-30T16:29:30+0300"
            },
            
            "messages": [
                    {
                        "from": "0000",
                        "to": "79034561231",
                        "text": "СМС сообщение 1",
                        "id": "super_id_1"
                    },
                    {
                        "from": "0000",
                        "to": "79034561232",
                        "text": "СМС сообщение 2",
                        "id": "super_id_2",
                        "validity": 60,
                        "priority": 1,
                        "callbackUrl": "http://url_Partner.ru"
                    },
                    {
                        "from": "0001",
                        "to": "79034561233",
                        "text": "СМС сообщение 3",
                        "id": "super_id_3",
                        "validity": 90,
                        "priority": 3,
                        "callbackUrl": "https://url_Partner.ru",
                    },
                    {
                        "from": "0002",
                        "to": "79034561234",
                        "text": "Текст. Follow link: <http://verylongurl.com/very/long/url>",
                        "id": "super_id_4"
                    }
                ]
            }


Параметры запроса
---------------------

**Обязательные** параметры выделены **жирным** шрифтом.

+---------------------------------+-------------------+-------------------------------------------------------------------------------------------------------------------------+
| Параметр                        | Тип               | Описание                                                                                                                |
+=================================+===================+=========================================================================================================================+
| shortenUrl                      | boolean           | | Флаг, который сокращает длину ссылки: если *true*, то ссылка будет сокращена.                                         |
|                                 |                   | | По умолчанию: *false*.                                                                                                |
|                                 |                   |                                                                                                                         |
|                                 |                   | .. note:: Значение параметра применяется для всех SMS-сообщений переданного пакета.                                     |
|                                 |                   |                                                                                                                         |
|                                 |                   | По умолчанию опция недоступна. Для подключения данной опции следует обратиться                                          |
|                                 |                   | в :ref:`Службу технической поддержки <support>`.                                                                        |
+---------------------------------+-------------------+-------------------------------------------------------------------------------------------------------------------------+
| scheduleInfo                    | object            | Расписание рассылки. Если расписание не указано, сообщения отправляются сразу же, в момент получения запроса.           |
+---------------------------------+-------------------+-------------------------------------------------------------------------------------------------------------------------+
| scheduleInfo/timeBegin          | string            | Время начала рассылки в формате ЧЧ:ММ, например, «10:00».                                                               |
+---------------------------------+-------------------+-------------------------------------------------------------------------------------------------------------------------+
| scheduleInfo/timeEnd            | string            | Время окончания рассылки в формате ЧЧ:ММ, например, «21:00».                                                            |
+---------------------------------+-------------------+-------------------------------------------------------------------------------------------------------------------------+
| scheduleInfo/weekdaysSchedule   | string            | Дни рассылки. Задаются цифрами от 1 (понедельник) до 7 (воскресение), например, «12345».                                |
|                                 |                   |                                                                                                                         |
|                                 |                   | Если ограничений по дням недели нет, то данный параметр может быть пустым или не передан в запросе.                     |
+---------------------------------+-------------------+-------------------------------------------------------------------------------------------------------------------------+
| scheduleInfo/deadline           | string            | Дата окончания рассылки в формате "YYYY-MM-ДДTчч:мм:сс+UTC", например, "2024-05-10T16:29:30+0300", где:                 |
|                                 |                   |                                                                                                                         |
|                                 |                   | * YYYY – указывает год;                                                                                                 |
|                                 |                   | * ММ – месяц;                                                                                                           |
|                                 |                   | * DD – день;                                                                                                            |
|                                 |                   | * T – указатель, указывающий на начальную часть времени;                                                                |
|                                 |                   | * чч – час;                                                                                                             |
|                                 |                   | * мм – минута;                                                                                                          |
|                                 |                   | * сс – секунды;                                                                                                         |
|                                 |                   | * знак “+” или “-” – положительный или отрицательный метод смещения времени;                                            |
|                                 |                   | * UTC – всемирное координированное время.                                                                               |
|                                 |                   |                                                                                                                         |
|                                 |                   | .. note:: Всем сообщениям, которые не были переданы до наступления даты окончания рассылки,                             |
|                                 |                   |           Платформой присваивается статус EXPIRED (Сообщение просрочено по сроку жизни).                                |
+---------------------------------+-------------------+-------------------------------------------------------------------------------------------------------------------------+
| useTimeDiff                     | boolean           | | Если *true*, то сообщение отправляется с учетом часового пояса абонента.                                              |
|                                 |                   | | Если *false*, то часовой пояс абонента не учитывается.                                                                |
|                                 |                   | | Значение по умолчанию: *false*.                                                                                       |
+---------------------------------+-------------------+-------------------------------------------------------------------------------------------------------------------------+
| **messages**                    | array of object   | Массив объектов, который содержит пакет сообщений на отправку.                                                          |
|                                 |                   |                                                                                                                         |
|                                 |                   | .. note:: В данном параметре возможно отправить сообщения абонентам с разных Сервисных имён,                            |
|                                 |                   |           доступных Партнёру, а также с разным текстом.                                                                 |
+---------------------------------+-------------------+-------------------------------------------------------------------------------------------------------------------------+
| **messages/from**               | string            | Сервисное имя.                                                                                                          |
+---------------------------------+-------------------+-------------------------------------------------------------------------------------------------------------------------+
| **messages/to**                 | string            | Номер телефона в международном формате XXX YYY ZZZ ZZ ZZ, согласно стандарту E.164, где:                                |
|                                 |                   |                                                                                                                         |
|                                 |                   | * XXX – международный код страны;                                                                                       |
|                                 |                   | * YYY – код оператора или города;                                                                                       |
|                                 |                   | * ZZZ ZZ ZZ – абонентский номер телефона.                                                                               |
|                                 |                   |                                                                                                                         |
|                                 |                   | Пример: 79031234567                                                                                                     |
+---------------------------------+-------------------+-------------------------------------------------------------------------------------------------------------------------+
| **messages/text**               | string            | | Текст сообщения.                                                                                                      |
|                                 |                   | | Максимальная длина текста: 2000 символов.                                                                             |
+---------------------------------+-------------------+-------------------------------------------------------------------------------------------------------------------------+
| messages/id                     | string            | | Уникальный идентификатор сообщения на стороне Партнёра.                                                               |
|                                 |                   | | Максимальная длина: 50 символов.                                                                                      |
|                                 |                   | | Сервис-провайдер возвращает этот параметр в ответе на запрос вместе со статусами сообщения.                           |
|                                 |                   | | Данный параметр может быть использован, в том числе, для контроля повторных отправок и дублирования.                  |
|                                 |                   | | В случае, если установлен запрет на отправку дубликатов, будет произведена проверка дубликатов сообщений по           |
|                                 |                   |   переданному id.                                                                                                       |
+---------------------------------+-------------------+-------------------------------------------------------------------------------------------------------------------------+
| messages/validity               | integer           | | Срок жизни сообщения в секундах.                                                                                      |
|                                 |                   | | Минимальное значение: 60 секунд.                                                                                      |
|                                 |                   | | Максимальное значение: 259200 секунд (3 суток).                                                                       |
|                                 |                   | | По умолчанию: 172800 секунд (2 суток).                                                                                |
+---------------------------------+-------------------+-------------------------------------------------------------------------------------------------------------------------+
| messages/priority               | integer           | | Приоритет отправки сообщения, от 0 до 3, где 0 – низкий приоритет, 3 – наивысший.                                     |
|                                 |                   | | По умолчанию: 0.                                                                                                      |
|                                 |                   | | По умолчанию опция недоступна. ля подключения данной опции следует обратиться в                                       |
|                                 |                   |   :ref:`Службу технической поддержки <support>`.                                                                        |
+---------------------------------+-------------------+-------------------------------------------------------------------------------------------------------------------------+
| messages/callbackUrl            | string            | URL, на который Платформа будет отправлять уведомления об изменениях статуса сообщения.                                 |
|                                 |                   | Любой валидный URL со схемой HTTP или HTTPS.                                                                            |
+---------------------------------+-------------------+-------------------------------------------------------------------------------------------------------------------------+


Ответ на запрос 
================

| После отправки сообщения Сервис-провайдер синхронно возвращает ответ.
| В теле ответа передается массив объектов *result*, содержащий результаты обработки для каждого SMS-сообщения исходного пакета.


.. tabs::

    .. tab:: Пример ответа

      .. code-block:: json
         :linenos:

            {
                "result": [
                    {
                        "code": "OK",
                        "messageId": "3482512350952730368"
                    },
                    {
                        "code": "REJECTED",
                        "messageId": null,
                        "reasons": [ 
                            {
                                "key": "not.available",
                                "ref": "messages[0].from"
                            } 
                        ],
                        "description": "Error: Source address in not available. Source address: TAXI"
                    }
                ]
            }



    .. tab:: Параметры ответа


        +---------------------------------+-------------------+--------------------------------------------------------------------------------------------------------------------+
        | Параметр                        | Тип               | Описание                                                                                                           |
        +=================================+===================+====================================================================================================================+
        | **result**                      | array of object   | Массив объектов, содержащий результаты обработки для каждого SMS-сообщения исходного пакета.                       |
        +---------------------------------+-------------------+--------------------------------------------------------------------------------------------------------------------+
        | **code**                        | string            | | Результат обработки сообщения.                                                                                   |
        |                                 |                   | | Возможные значение:                                                                                              |
        |                                 |                   |                                                                                                                    |
        |                                 |                   | * OK – успешно;                                                                                                    |
        |                                 |                   | * REJECTED – ошибка обработки запроса.                                                                             |
        +---------------------------------+-------------------+--------------------------------------------------------------------------------------------------------------------+
        | messageId                       | string            | | Идентификатор сообщения.                                                                                         |
        |                                 |                   | | При *code=OK* возвращается реальное значение.                                                                    |
        |                                 |                   | | При *code=REJECTED* возвращается значение *null*.                                                                |
        +---------------------------------+-------------------+--------------------------------------------------------------------------------------------------------------------+
        | description                     | string            | | Описание ошибки.                                                                                                 |
        |                                 |                   | | Возвращается только при *code=REJECTED*.                                                                         |
        +---------------------------------+-------------------+--------------------------------------------------------------------------------------------------------------------+
        | id                              | string            | Идентификатор сообщения на стороне Партнёра.                                                                       |
        +---------------------------------+-------------------+--------------------------------------------------------------------------------------------------------------------+
        | packetId                        | object            | | Идентификатор пакета SMS-сообщений.                                                                              |
        |                                 |                   | | У всех сообщений пакета будет одинаковый идентификатор, присвоенный данному пакету сообщений.                    |
        |                                 |                   | | В ответ на запрос по данному параметру Партнёр имеет возможность запросить статусы сообщений.                    |
        |                                 |                   | | Для передачи данного параметра в запросе Партнёру необходимо обратиться в                                        |
        |                                 |                   |   :ref:`Службу технической поддержки <support>`.                                                                   |
        +---------------------------------+-------------------+--------------------------------------------------------------------------------------------------------------------+
        | reasons                         | array of object   | | Массив объектов, содержащий параметры ошибок, возникших при обработке сообщения.                                 |
        |                                 |                   | | Возвращается только при *code=REJECTED*.                                                                         |
        +---------------------------------+-------------------+--------------------------------------------------------------------------------------------------------------------+
        | reasons/**key**                 | string            | Код ошибки (см. :ref:`RB-Коды-ошибок-отправки-SMS`).                                                               |
        +---------------------------------+-------------------+--------------------------------------------------------------------------------------------------------------------+
        | reasons/ref                     | string            | Ссылка на параметр, в котором произошла ошибка (см. :ref:`RB-Коды-ошибок-отправки-SMS`).                           |
        +---------------------------------+-------------------+--------------------------------------------------------------------------------------------------------------------+



.. _RB-Коды-ошибок-отправки-SMS: 

Ошибки при отправке 
----------------------

Ошибки параметра *reasons/key*, возвращаемые при первичном приёме пакета сообщений.

+---------------------------------+---------------------------------------+---------------------------------------------------------------------+
| key                             | ref                                   | Описание                                                            |
+=================================+=======================================+=====================================================================+
| forbidden                       |                                       | Отправка запрещена.                                                 |
+---------------------------------+---------------------------------------+---------------------------------------------------------------------+
| unknown                         |                                       | Неизвестная ошибка.                                                 |
+---------------------------------+---------------------------------------+---------------------------------------------------------------------+
| invalid                         | messages[i].to                        | Неправильно указан номер телефона.                                  |
|                                 +---------------------------------------+---------------------------------------------------------------------+
|                                 | messages[i].validity                  | Неправильно указан срок жизни.                                      |
|                                 +---------------------------------------+---------------------------------------------------------------------+
|                                 | messages[i].callbackUrl               | Неправильно указан URL.                                             |
+---------------------------------+---------------------------------------+---------------------------------------------------------------------+
| length.too.long                 | messages[i].text                      | Превышена максимальная длина текста сообщения.                      |
+---------------------------------+---------------------------------------+---------------------------------------------------------------------+
| must.be.not.null                | messages                              | Массив *messages* не может быть пустым.                             |
+---------------------------------+---------------------------------------+---------------------------------------------------------------------+
| not.available                   | messages[i].from                      | Неправильно указан отправитель.                                     |
+---------------------------------+---------------------------------------+---------------------------------------------------------------------+
| too.many.messages               | messages                              | Превышен максимальный размер массива *messages*.                    |
+---------------------------------+---------------------------------------+---------------------------------------------------------------------+



Статусы доставки SMS-сообщений
-------------------------------

Для получения статусов SMS-сообщений необходимо настроить :doc:`rest_batch_status`.

