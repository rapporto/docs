Сервис получения статусов доставки
=========================================

Описание сервиса
--------------------

Сервис-провайдер отправляет Партнёру отчёт о доставке сообщений, передавая его на настроенный URL для передачи статусов доставки. 

URL для передачи статусов задается в настройках интеграции при подключении сервиса.

Расширенные статусы отправленных сообщений доступны опционально. Для получения расширенных статусов необходимо обратиться в :ref:`Службу технической поддержки <support>` Сервис-провайдера.

Метод передачи данных: GET.

Протокол взаимодействия: HTTP 1.1.

Взаимодействие синхронное.

Схема взаимодействия:

1. Партнёр направляет Сервис-провайдеру запрос на отправку сообщения.
2. Сервис-провайдер обрабатывает запрос, возвращает Партнёру идентификатор сообщения.
3. Сервис-провайдер обрабатывает сообщение – передает сообщение Оператору для отправки абоненту.
4. Оператор отправляет абоненту сообщение и возвращает Сервис-провайдеру статус доставки.
5. Сервис-провайдер направляет Партнёру запрос, содержащий информацию о статусе доставки сообщения.


GET-запрос 
--------------

.. tabs::

    .. tab:: Пример GET-запроса

      Пример запроса от Сервис-провайдера Партнёру для получения статусов сообщений.

      .. code-block::
           
            http://partner.url?msgType=SMS&transactionId=7986985&ptag=test&status=2
            

    .. tab:: Параметры GET-запроса

      В таблице **обязательные** параметры выделены **жирным** шрифтом.

      +---------------------+----------+---------------------------------------------------------------------------------+
      | Параметр            | Тип      | Описание                                                                        |
      +=====================+==========+=================================================================================+
      | msgType             | string   | | Тип сообщения.                                                                |
      |                     |          | | Возможные значения:                                                           |
      |                     |          |                                                                                 |
      |                     |          | * VIBER;                                                                        |
      |                     |          | * SMS;                                                                          |
      |                     |          | * VK;                                                                           |
      |                     |          | * WHATSAPP;                                                                     |
      |                     |          | * PUSH;                                                                         |
      |                     |          | * FLASHINGCALL.                                                                 |
      +---------------------+----------+---------------------------------------------------------------------------------+
      | **transactionId**   | long     | Идентификатор сообщения в базе Сервис-провайдера, который был передан Партнёру  |
      |                     |          | в теле ответа на запрос на отправку сообщения.                                  |
      |                     |          |                                                                                 |
      |                     |          | 64-битное целое положительное число.                                            |
      +---------------------+----------+---------------------------------------------------------------------------------+
      | ptag                | string   | Идентификатор сообщения в системе Партнёра, который был передан                 |
      |                     |          | Сервис-провайдеру в запросе на отправку сообщения в параметре *ptag*.           |
      |                     |          |                                                                                 |
      |                     |          | | Максимальная длина: от 1 до 50 символов.                                      |
      |                     |          | | Допустимые символы: 0...9a...zA...Z-                                          |  
      +---------------------+----------+---------------------------------------------------------------------------------+
      | **status**          | integer  | Статус доставки сообщения. Возможные значения:                                  |
      |                     |          |                                                                                 |
      |                     |          | * 0 – сообщение отправлено в сторону оператора, финальный статус пока не        |
      |                     |          |   известен;                                                                     |
      |                     |          | * 2 – сообщение доставлено;                                                     |
      |                     |          | * 5 – сообщение не доставлено;                                                  |
      |                     |          | * 9 – сообщение прочитано (для VK, Viber, WhatsApp, PUSH).                      |
      |                     |          |                                                                                 |
      |                     |          | .. warning:: Для SMS-сообщений, предназначенных для абонентов оператора Мегафон,|
      |                     |          |      с 01.03.2023 прекращена передача статусов "Доставлено" и "Не доставлено".  |
      +---------------------+----------+---------------------------------------------------------------------------------+
      | partnerMsgId        | string   | Уникальный идентификатор сообщения в системе Партнёра, который был передан      |
      |                     |          | Сервис-провайдеру в запросе на отправку сообщения в параметре *partnerMsgId*.   |
      |                     |          |                                                                                 |
      |                     |          | Длина параметра: не более 50 символов.                                          |
      +---------------------+----------+---------------------------------------------------------------------------------+
      | unifiedExtStatus    | string   | Унифицированный расширенный статус доставки сообщения.                          |
      |                     |          |                                                                                 |
      |                     |          | Описание кодов ошибок приведено :ref:`ниже <ErrCodeDescr>`.                     |
      +---------------------+----------+---------------------------------------------------------------------------------+

Ответ на запрос
--------------------

| Партнёр должен синхронно ответить на запрос одним из HTTP-статусов. 
| Описание статусов, а также порядок действий Сервис-провайдера при получении данных статусов приведены в таблице.

+----------------------+-------------------------------------------------------------------+---------------------------------------------+
| Статус               | Описание                                                          | Порядок действий Сервис-провайдера          |
+======================+===================================================================+=============================================+
| 200                  | ОК. Успешная обработка запроса Партнёром.                         | Финальный статус. Штатная работа.           |
+----------------------+-------------------------------------------------------------------+---------------------------------------------+
| 400                  | Неверные значения параметров: несуществующие в базе Партнёра      | Сервис-провайдер повторно отправляет запрос |
|                      | идентификаторы *transactionId* или *ptag*.                        | Партнёру согласно конфигурации сервиса.     |
+----------------------+-------------------------------------------------------------------+                                             |
| 500                  | Внутренняя ошибка сервиса Партнёра. Технические проблемы на       |                                             |
|                      | стороне Партнёра.                                                 |                                             |
+----------------------+-------------------------------------------------------------------+---------------------------------------------+


.. _ErrCodeDescr:

Описание кодов ошибок (параметр *unifiedExtStatus*)
----------------------------------------------------------

В разделе приведено описание причин недоставки сообщений разных типов.

.. tabs::

      .. tab:: FlashingCall (VoiceCode)

            +----------------------------+--------------------------------------------------------------------------------+
            | Значение unifiedExtStatus  | Описание статусов                                                              |
            +============================+================================================================================+
            | 1                          | В процессе доставки сообщения произошла неизвестная платформе ошибка,          |
            |                            | либо оператор не предоставил ошибку в отчете о доставке.                       |
            +----------------------------+--------------------------------------------------------------------------------+
            | 2                          | Аппарат абонента был выключен или находился вне зоны действия сети на          |
            |                            | протяжении всего времени попыток доставки сообщения.                           |
            +----------------------------+--------------------------------------------------------------------------------+
            | 4                          | В процессе доставки сообщения произошла ошибка на транспортном уровне          |
            |                            | сигнальной сети.                                                               |
            +----------------------------+--------------------------------------------------------------------------------+
            | 6                          | У абонента не подключена услуга приема сообщений.                              |
            +----------------------------+--------------------------------------------------------------------------------+
            | 16                         | Номер абонента занят.                                                          |
            +----------------------------+--------------------------------------------------------------------------------+

      .. tab:: SMS

            +----------------------------+--------------------------------------------------------------------------------+
            | Значение unifiedExtStatus  | Описание статусов                                                              |
            +============================+================================================================================+
            | 1                          | В процессе доставки сообщения произошла неизвестная платформе ошибка, либо     |
            |                            | оператор не предоставил ошибку в отчете о доставке.                            |
            +----------------------------+--------------------------------------------------------------------------------+
            | 2                          | Аппарат абонента был выключен или находился вне зоны действия сети на          |
            |                            | протяжении всего времени попыток доставки сообщения.                           |
            +----------------------------+--------------------------------------------------------------------------------+
            | 3                          | Аппарат абонента заблокирован, либо у абонента включен запрет на прием         |
            |                            | сообщений, либо абонент находится в роуминге с включенным запретом на прием    |
            |                            | сообщений в роуминге.                                                          |
            +----------------------------+--------------------------------------------------------------------------------+
            | 4                          | В процессе доставки сообщения произошла ошибка на транспортном уровне          |
            |                            | сигнальной сети.                                                               |
            +----------------------------+--------------------------------------------------------------------------------+
            | 5                          | Память телефона абонента переполнена.                                          |
            +----------------------------+--------------------------------------------------------------------------------+
            | 6                          | У абонента не подключена услуга приема сообщений.                              |
            +----------------------------+--------------------------------------------------------------------------------+
            | 7                          | Коммутационное оборудование, на котором зарегистрирован абонент, не отвечает.  |
            +----------------------------+--------------------------------------------------------------------------------+
            | 8                          | Некорректный номер абонента, либо телефон абонента был выключен на             |
            |                            | протяжении очень долгого периода времени.                                      |
            +----------------------------+--------------------------------------------------------------------------------+
            | 9                          | Сообщение было отброшено платформой, так как сработал механизмом отсечения     |
            |                            | дубликатов сообщений.                                                          |
            +----------------------------+--------------------------------------------------------------------------------+
            | 10                         | Сообщение было отброшено платформой, так как сработал один из фильтров         |
            |                            | сообщений, например, спам-фильтр.                                              |
            +----------------------------+--------------------------------------------------------------------------------+
            | 11                         | Ошибка маршрутизации в конфигурации платформы.                                 |
            +----------------------------+--------------------------------------------------------------------------------+
            | 12                         | Номер абонента находится в чёрном списке оператора.                            |
            +----------------------------+--------------------------------------------------------------------------------+
            | 13                         | Отправка сообщения с незарегистрированного у оператора имени отправителя.      |
            +----------------------------+--------------------------------------------------------------------------------+
            | 14                         | На стороне оператора сработал СПАМ-фильтр по тексту сообщения.                 |
            +----------------------------+--------------------------------------------------------------------------------+
 
      .. tab:: Viber

            +----------------------------+--------------------------------------------------------------------------------+
            | Значение unifiedExtStatus  | Описание статусов                                                              |
            +============================+================================================================================+
            | 1                          | В процессе доставки сообщения произошла неизвестная платформе ошибка,          |
            |                            | либо оператор не предоставил ошибку в отчете о доставке.                       |
            +----------------------------+--------------------------------------------------------------------------------+
            | 2                          | Аппарат абонента был выключен или находился вне зоны действия сети на          |
            |                            | протяжении всего времени попыток доставки сообщения.                           |
            +----------------------------+--------------------------------------------------------------------------------+
            | 3                          | Аппарат абонента заблокирован, либо у абонента включен запрет на прием         |
            |                            | сообщений, либо абонент находится в роуминге с включенным запретом на прием    |
            |                            | сообщений в роуминге.                                                          |
            +----------------------------+--------------------------------------------------------------------------------+
            | 5                          | Память телефона абонента переполнена.                                          |
            +----------------------------+--------------------------------------------------------------------------------+
            | 6                          | У абонента не подключена услуга приема сообщений.                              |
            +----------------------------+--------------------------------------------------------------------------------+
            | 7                          | Коммутационное оборудование, на котором зарегистрирован абонент, не отвечает.  |
            +----------------------------+--------------------------------------------------------------------------------+
            | 9                          | Сообщение было отброшено платформой, так как сработал механизмом отсечения     |
            |                            | дубликатов сообщений.                                                          |
            +----------------------------+--------------------------------------------------------------------------------+
            | 11                         | Ошибка маршрутизации в конфигурации платформы.                                 |
            +----------------------------+--------------------------------------------------------------------------------+

      .. tab:: VK

            +----------------------------+--------------------------------------------------------------------------------+
            | Значение unifiedExtStatus  | Описание статусов                                                              |
            +============================+================================================================================+
            | 1                          | В процессе доставки сообщения произошла неизвестная платформе ошибка,          |
            |                            | либо оператор не предоставил ошибку в отчете о доставке.                       |
            +----------------------------+--------------------------------------------------------------------------------+
            | 3                          | Аппарат абонента заблокирован, либо у абонента включен запрет на прием         |
            |                            | сообщений, либо абонент находится в роуминге с включенным запретом на прием    |
            |                            | сообщений в роуминге.                                                          |
            +----------------------------+--------------------------------------------------------------------------------+
            | 6                          | У абонента не подключена услуга приема сообщений.                              |
            +----------------------------+--------------------------------------------------------------------------------+
            | 10                         | Сообщение было отброшено платформой, так как сработал один из фильтров         |
            |                            | сообщений, например, спам-фильтр.                                              |
            +----------------------------+--------------------------------------------------------------------------------+
            | 11                         | Ошибка маршрутизации в конфигурации платформы.                                 | 
            +----------------------------+--------------------------------------------------------------------------------+

      .. tab:: WhatsApp

            +----------------------------+--------------------------------------------------------------------------------+
            | Значение unifiedExtStatus  | Описание статусов                                                              |
            +============================+================================================================================+
            | 3                          | Аппарат абонента заблокирован, либо у абонента включен запрет на прием         |
            |                            | сообщений, либо абонент находится в роуминге с включенным запретом на прием    |
            |                            | сообщений в роуминге.                                                          |
            +----------------------------+--------------------------------------------------------------------------------+
            | 6                          | У абонента не подключена услуга приема сообщений.                              |
            +----------------------------+--------------------------------------------------------------------------------+
            | 7                          | Коммутационное оборудование, на котором зарегистрирован абонент, не отвечает.  |
            +----------------------------+--------------------------------------------------------------------------------+
            | 10                         | Сообщение было отброшено платформой, так как сработал один из фильтров         |
            |                            | сообщений, например, спам-фильтр.                                              |
            +----------------------------+--------------------------------------------------------------------------------+
      
      .. tab:: Push

            +----------------------------+--------------------------------------------------------------------------------+
            | Значение unifiedExtStatus  | Описание статусов                                                              | 
            +============================+================================================================================+
            | 1                          | В процессе доставки сообщения произошла неизвестная платформе ошибка,          |
            |                            | либо оператор не предоставил ошибку в отчете о доставке.                       |
            +----------------------------+--------------------------------------------------------------------------------+
            | 8                          | Некорректный номер абонента, либо телефон абонента был выключен на             |
            |                            | протяжении очень долгого периода времени.                                      |
            +----------------------------+--------------------------------------------------------------------------------+
            | 9                          | Сообщение было отброшено платформой, так как сработал механизмом отсечения     |
            |                            | дубликатов сообщений.                                                          |
            +----------------------------+--------------------------------------------------------------------------------+
            | 11                         | Ошибка маршрутизации в конфигурации платформы.                                 |
            +----------------------------+--------------------------------------------------------------------------------+
            | 13                         | Отправка сообщения с незарегистрированного у оператора имени отправителя.      |
            +----------------------------+--------------------------------------------------------------------------------+


