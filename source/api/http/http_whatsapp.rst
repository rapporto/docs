WhatsApp
=====================

Через HTTP API в WhatsApp поддерживается отправка только текстовых сообщений.

| Время жизни WhatsApp-сообщений, минут: 1440, 2880, 4320, 5760, 7200, 8640, 10080 (кратное суткам), либо от 1 до 10080 минут (на стороне оператора значение округляется до суток).
| :term:`Время жизни сообщения` настраивается на стороне Сервис-провайдера по согласованию с Партнёром.

Запрос на отправку сообщений 
------------------------------------------

В HTTP API допустимы POST и GET запросы.

Примеры запросов
~~~~~~~~~~~~~~~~~~~~

.. tabs::

    .. tab:: POST-запросы

        .. tabs::

            .. tab:: Текстовый формат

                POST-запрос с сообщением на латинице “test“ в простом текстовом формате.

                .. code-block::

                    POST /login HTTP/1.1
                    Host: 10.10.10.10:9080
                    Content-Type: application/x-www-form-urlencoded;charset=utf-8
                    Content-Length: 58
                    serviceId=login&pass=123&clientId=79161234567&message=test
                    

            .. tab:: Текст в URL-формате

                POST-запрос с текстом сообщения на кириллице “тест“ в URL-формате.

                .. code-block::

                    POST /login HTTP/1.1
                    Host: 10.241.0.194:9080
                    Content-Type: application/x-www-form-urlencoded;charset=utf-8
                    Content-Length: 78
                    serviceId=login&pass=123&clientId=79161234567&message=%D1%82%D0%B5%D1%81%D1%82
                    


    .. tab:: GET-запросы

        .. tabs::

            .. tab:: Текстовый формат

                GET-запрос с сообщением на латинице “test“ в простом текстовом формате.

                .. code-block::

                    http://partner.ru/login?clientId=79161234567&message=test&pass=123&serviceId=login
                    

            .. tab:: Текст в URL-формате

                GET-запрос с текстом сообщения на кириллице “тест“ в URL-формате.

                .. code-block::

                    http://partner.ru/login?clientId=79161234567&message=%D1%82%D0%B5%D1%81%D1%82&pass=123&serviceId=login
                    


.. _HTTP-WA-параметры-запроса:

Параметры запросов
~~~~~~~~~~~~~~~~~~~~~~

Параметры применимы для POST и GET запросов.

В таблице **обязательные** параметры выделены **жирным** шрифтом.

+---------------------------+-------------------------+----------------------------------------------------------------------------------+
| Параметр                  | Тип                     | Описание                                                                         |
+===========================+=========================+==================================================================================+
| **clientId**              | string                  | | Номер телефона абонента, до 25 символов.                                       |
|                           |                         | | Примеры: 79036550550, +79036550550, 8-903-655-05-50, 89036550550.              |
+---------------------------+-------------------------+----------------------------------------------------------------------------------+
| message                   | string                  | | Текст сообщения в кодировке UTF-8.                                             |
|                           |                         | | Максимальная длина: 1000 символов.                                             |
+---------------------------+-------------------------+----------------------------------------------------------------------------------+
| **serviceId**             | string                  | Идентификатор сервиса (логин), от имени которого происходит отправка сообщения.  |
|                           |                         | Логин serviceId заводится Сервис-провайдером при подключении сервиса и           |
|                           |                         | сообщается Партнёру.                                                             |
+---------------------------+-------------------------+----------------------------------------------------------------------------------+
| **pass**                  | string                  | Пароль для авторизации в сервисе. Пароль заводится Сервис-провайдером при        |
|                           |                         | подключении сервиса и сообщается Партнёру.                                       |
+---------------------------+-------------------------+----------------------------------------------------------------------------------+
| ptag                      | string                  | | Идентификатор сообщения в системе Партнёра.                                    |
|                           |                         | | Может содержать от одного до 50 символов.                                      |
|                           |                         | | Допустимые символы: 0...9a...zA...Z-                                           |
|                           |                         | | Это может быть любой идентификатор в системе Партнёра.                         |
|                           |                         |                                                                                  |
|                           |                         | .. note::                                                                        |
|                           |                         |     Например, уникальный идентификатор сообщения или идентификатор подразделения,|
|                           |                         |     инициирующего запрос на отправку. В отличие от параметра *partnerMsgId*,     |
|                           |                         |     который нужен для контроля повторных отправок и дублирования,                |
|                           |                         |     Сервис-провайдер не контролирует значения, переданные в параметре            |
|                           |                         |     *ptag* (проверяется только соответствие формату).                            |
|                           |                         |                                                                                  |
|                           |                         | Сервис-провайдер опционально возвращает Партнёру данный идентификатор в рамках   |
|                           |                         | запроса на получение статуса доставки сообщения (этот функционал подробно описан |
|                           |                         | в разделе «Сервис получения статусов доставки сообщений»).                       |
+---------------------------+-------------------------+----------------------------------------------------------------------------------+
| sending_time              | string                  | | Локальное время отправки сообщения абоненту.                                   |
|                           |                         | | Задается в формате *hh_hh*, где два значения часа задают временной             |
|                           |                         |   промежуток, в который должно быть отправлено сообщение.                        |
|                           |                         |                                                                                  |
|                           |                         | .. warning:: Если параметр указан, то его значение не может быть пустым.         |
|                           |                         |                                                                                  |
|                           |                         | .. note:: Например, при значении параметра *sending_time=10_20*,                 |
|                           |                         |     сообщение будет отправлено в период с 10:00 до 20:00 по местному времени     |
|                           |                         |     в часовом поясе абонента.                                                    |
|                           |                         |                                                                                  |
|                           |                         | | Часовой пояс абонента определяется *не* по фактическому местоположению         |
|                           |                         |   абонента.                                                                      |
|                           |                         | | Если Партнёр не передает параметр *time_zone*, то часовой пояс абонента        |
|                           |                         |   определяется по номеру телефона.                                               |
|                           |                         | | Если Партнёр передает в параметре *time_zone* часовой пояс, то сообщение будет |
|                           |                         |   отправлено абоненту по местному времени этого часового пояса.                  |
+---------------------------+-------------------------+----------------------------------------------------------------------------------+
| time_zone                 | string                  | Часовой пояс абонента. Задается в формате *±hh:mm*. Подробнее о формате см.      |
|                           |                         | `ISO 8601 <http://en.wikipedia.org/wiki/ISO_8601#Time_offsets_from_UTC>`_.       |
|                           |                         |                                                                                  |
|                           |                         | Если Партнёр передает в этом параметре часовой пояс, то сообщение будет          |
|                           |                         | отправлено абоненту по местному времени этого часового пояса, иначе часовой      |
|                           |                         | пояс абонента определяется по номеру телефона абонента.                          |
|                           |                         |                                                                                  |
|                           |                         | .. note:: Абонент с хабаровским номером находится в Москве.                      |
|                           |                         |     Возможны следующие варианты отправки:                                        |
|                           |                         |                                                                                  |
|                           |                         |     1. Получены значения: *sending_time=10_20*, *time_zone=+04:00*               |
|                           |                         |        (московское время).                                                       |
|                           |                         |                                                                                  |
|                           |                         |        Сообщение будет отправлено в период с 10:00 до 20:00 по московскому       |
|                           |                         |        времени.                                                                  |
|                           |                         |                                                                                  |
|                           |                         |     2. Получено значение *sending_time=10_20* и не передан параметр *time_zone*. |
|                           |                         |        Сообщение будет отправлено в период с 10:00 до 20:00 по хабаровскому      |
|                           |                         |        времени.                                                                  |
|                           |                         |                                                                                  |
|                           |                         | | Для нулевой зоны обязательно указание знака, неважно "+" или "-".              |
|                           |                         | | Знак "+" при кодировании URL преобразуется в "%2B".                            |
|                           |                         | | Например, часовой пояс +04:00 передается так time_zone= %2B04:00.              |
+---------------------------+-------------------------+----------------------------------------------------------------------------------+
| source                    | string                  | Имя отправителя. Сообщение абоненту будет отправлено с сервисного имени,         |
|                           |                         | указанного в данном параметре.                                                   |
|                           |                         |                                                                                  |
|                           |                         | Данный параметр не является обязательным. Если параметр отсутствует в запросе,   |
|                           |                         | то сообщение будет отправлено абоненту с имени по умолчанию (настройка на        |
|                           |                         | стороне Сервис-провайдера).                                                      |
|                           |                         |                                                                                  |
|                           |                         | .. important:: Использование данного параметра недоступно для Партнёра           |
|                           |                         |     по умолчанию. Функционал может быть включен после согласования с             |
|                           |                         |     Сервис-провайдером. В этом случае для Партнёра настраивается список          |
|                           |                         |     разрешенных имен отправителей, либо включается функционал динамической       |
|                           |                         |     подписи.                                                                     |
+---------------------------+-------------------------+----------------------------------------------------------------------------------+
| output                    | string                  | Формат ответа на запрос.                                                         |
|                           |                         |                                                                                  |
|                           |                         | Если *output=xml*, то ответ на запрос будет сформирован в виде XML               |
|                           |                         | (см. :ref:`Ответ в формате XML <WA Ответ в формате XML>`).                       |
|                           |                         |                                                                                  |
|                           |                         | Если параметр не задан или имеет другое значение, будет применён формат          |
|                           |                         | по умолчанию: :abbr:`text/plain (Простой текст)`                                 |
|                           |                         | (см. :ref:`Ответ на запрос <WA Ответ на запрос>`).                               |
+---------------------------+-------------------------+----------------------------------------------------------------------------------+
| partnerMsgId              | string                  | Уникальный идентификатор сообщения в системе Партнёра.                           |
|                           |                         | Допустимая длина: от одного до 50 символов.                                      |
|                           |                         |                                                                                  |
|                           |                         | Данный параметр используется для контроля повторных отправок и дублирования.     |
|                           |                         | Партнёр может отправить запрос на отправку сообщения с одним и тем же            |
|                           |                         | *partnerMsgId* несколько раз.                                                    |
|                           |                         |                                                                                  |
|                           |                         | При этом:                                                                        |
|                           |                         |                                                                                  |
|                           |                         | * отправка сообщения абоненту будет выполнена только один раз                    |
|                           |                         |   (по первому запросу);                                                          |
|                           |                         | * в ответах на данные запросы Сервис-провайдер вернет Партнёру один и тот же     |
|                           |                         |   идентификатор сообщения в системе Сервис-провайдера (тот же, что на первый     |
|                           |                         |   запрос).                                                                       |
|                           |                         |                                                                                  |
|                           |                         | Сервис-провайдер опционально возвращает Партнёру данный идентификатор            |
|                           |                         | в рамках запроса на получение статуса доставки сообщения                         |
|                           |                         | (См. :doc:`http_status`).                                                        |
|                           |                         |                                                                                  |
|                           |                         | Использование данного параметра недоступно по умолчанию.                         |
|                           |                         | Подключение данного функционала нужно согласовать со своим курирующим менеджером.|
+---------------------------+-------------------------+----------------------------------------------------------------------------------+
| shortenLinks              | boolean                 | Параметр указывает, требуется ли сокращать ссылки в тексте сообщения.            |
|                           |                         |                                                                                  |
|                           |                         | .. important:: Используется только для одиночных сообщений.                      |
|                           |                         |                                                                                  |
|                           |                         | В случае каскадной доотправки необходимо использовать параметр *shorten_list*    |
|                           |                         | (См. :doc:`http_cascade`).                                                       |
|                           |                         |                                                                                  |
|                           |                         | .. important:: Использование данного параметра недоступно по умолчанию.          |
|                           |                         |     Подключение данного функционала необходимо согласовать со своим курирующим   |
|                           |                         |     менеджером.                                                                  |
|                           |                         |                                                                                  |
|                           |                         | Подробнее о сервисе сокращения ссылок: `Сервис сокращения ссылок для             |
|                           |                         | интеграционных схем - Документация API - Rapporto Documentation                  |
|                           |                         | <https://docs.rapporto.ru/pages/viewpage.action?pageId=7962661>`_.               |
+---------------------------+-------------------------+----------------------------------------------------------------------------------+



.. _WA Ответ на запрос:

Ответ на запрос 
----------------------

| После получения и обработки запроса Сервис-провайдер синхронно возвращает Партнёру ответ. 
| По умолчанию ответ от Сервис-провайдера приходит в формате :abbr:`text/plain (Простой текст)`.
| По согласованию с Партнёром ответ может быть сформирован в формате :abbr:`XML (Xtensible Markup Language - расширяемый язык разметки)`. 


.. note:: Сервис-провайдер отправляет сообщения абонентам только при успешной обработке запроса.


Ответ при успешной отправке запроса
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

На успешный запрос Сервис-провайдер возвращает Партнёру:

* HTTP-код "200 OK"; 
* идентификатор сообщения в системе Сервис-провайдера. 

.. tabs::

    .. tab:: Пример ответа

        .. code-block:: 

            OK
            4095284974
            

    .. tab:: Параметры ответа

        +---------------+-----------------------------------------------------------+-----------------------------------------------------------+
        | Ответный код  | Описание                                                  | Возможные действия Партнера                               |
        +===============+===========================================================+===========================================================+
        | 200           | | Успешная обработка запроса.                             | Штатная работа с сервисом.                                |
        |               | | В теле ответа передаётся идентификатор, присвоенный     |                                                           |
        |               |   сообщению Сервис-провайдером.                           |                                                           |
        |               | | Идентификатор представляет собой 64-битное целое        |                                                           |
        |               |   положительное число.                                    |                                                           |
        +---------------+-----------------------------------------------------------+-----------------------------------------------------------+




Ошибки при отправке запроса
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

При передаче ошибочного запроса в теле ответа может возвращаться короткое текстовое сообщение об ошибке.

.. tabs::

    .. tab:: Пример ответа

        Пример ответа в случае возникновения ошибки  неверного сочетания *serviceId/pass*:

        .. code-block::

            Invalid password
            

    .. _Коды-ошб-при-отпр-запроса:

    .. tab:: Коды ошибок при отправке запроса

        +---------------+-----------------------------------------------------------+-----------------------------------------------------------+
        | Ответный код  | Описание                                                  | Возможные действия Партнера                               |
        +===============+===========================================================+===========================================================+
        | 400           | Отсутствуют обязательные параметры или они заданы         | Повторить запрос с правильным сочетанием параметров и их  |
        |               | некорректно.                                              | корректными значениями.                                   |
        |               |                                                           |                                                           |
        |               | Например, не передан параметр *message*                   |                                                           |
        |               | (там, где он необходим).                                  |                                                           |
        +---------------+-----------------------------------------------------------+-----------------------------------------------------------+
        | 401           | Передано неверное сочетание параметров *serviceId*        | Повторить запрос с верными значениями параметров          |
        |               | и *pass*.                                                 | *serviceId* и *pass*.                                     |
        |               |                                                           |                                                           |
        +---------------+-----------------------------------------------------------+-----------------------------------------------------------+
        | 402           | Исчерпан остаток оплаченных сообщений (для Партнёров,     | Для возобновления отправки сообщений необходимо внести    |
        |               | работающих по предоплате).                                | предоплату и обратиться к вашему курирующему менеджеру.   |
        |               |                                                           |                                                           |
        |               |                                                           | Партнёр не должен повторять запрос.                       |
        +---------------+-----------------------------------------------------------+-----------------------------------------------------------+
        | 403           | Сервис с переданным *serviceId* отсутствует или           | Следует обратиться к своему курирующему менеджеру.        |
        |               | не активен.                                               |                                                           |
        |               |                                                           | Партнёр не должен повторять запрос.                       |
        +---------------+-----------------------------------------------------------+-----------------------------------------------------------+
        | 406           | Невозможно послать сообщение абоненту с                   | Партнёр не должен повторять запрос.                       |
        |               | переданным *clientId*.                                    |                                                           |
        +---------------+-----------------------------------------------------------+-----------------------------------------------------------+
        | 408           | Превышение допустимой скорости отправки сообщений.        | Партнёр может повторить запрос, не превышая допустимой    | 
        |               |                                                           | скорости.                                                 |
        |               | .. note:: Для сервиса Партнёра установлена допустимая     |                                                           |
        |               |       скорость 10 запросов в секунду. Партнёр отправил    |                                                           |
        |               |       12 запросов в секунду. Первые 10 запросов будут     |                                                           |
        |               |       успешно обработаны: в ответ на эти запросы          |                                                           |
        |               |       Сервис-провайдер вернет Партнёру статус 200 и       |                                                           |
        |               |       отправит сообщения абонентам. В ответ на последние  |                                                           |
        |               |       2 запроса Сервис-провайдер вернет Партнёру статус   |                                                           |
        |               |       408 и не будет отправлять сообщения абонентам.      |                                                           |
        +---------------+-----------------------------------------------------------+-----------------------------------------------------------+
        | 409           | Запрещена отправка дубликатов.                            | Партнёр не должен повторять запрос.                       |
        |               |                                                           |                                                           |
        |               | .. note:: Для сервиса Партнёра включен функционал         | При необходимости отправки дубликата сообщения, Партнёр   |
        |               |       блокировки дубликатов. Партнёр отправил в течении   | может обратиться в службу техподдержки Сервис-провайдера, |
        |               |       суток три запроса для отправки сообщения на один    | предоставив наиболее полную информацию об условиях        |
        |               |       номер с одинаковым текстом.                         | возникновения данной ситуации.                            |
        |               |       Первый запрос будет успешно обработан и сообщение   |                                                           |
        |               |       будет отправлено абоненту. В ответ на последние два |                                                           |
        |               |       запроса Сервис-провайдер вернет Партнёру статус 409 |                                                           |
        |               |       и не будет отправлять эти два сообщения абоненту.   |                                                           |
        |               |                                                           |                                                           |
        |               | Функционал блокировки дубликатов по умолчанию отключен    |                                                           |
        |               | для Партнёра. Функционал может быть включен по просьбе    |                                                           |
        |               | Партнёра. Также Сервис-провайдер может включить функционал|                                                           |
        |               | блокировки дубликатов для Партнёра при необходимости:     |                                                           |
        |               | например, в ответ на жалобы абонентов.                    |                                                           |
        +---------------+-----------------------------------------------------------+-----------------------------------------------------------+
        | 414           | Превышение допустимой длины текста сообщения,             | Партнёр может повторить запрос, сократив текст сообщения  |
        |               | переданного в параметре *message*.                        | до допустимой длины.                                      |
        +---------------+-----------------------------------------------------------+-----------------------------------------------------------+
        | 500           | Внутренняя ошибка сервера. Технические проблемы на стороне| При получении статуса 500 или при истечении тайм-аута     |
        |               | Сервис-провайдера.                                        | ожидания ответа, Партнёр должен выдержать паузу минимум 1 | 
        |               |                                                           | минуту. По истечении паузы Партнёр может повторить запрос.|
        |               |                                                           |                                                           |
        |               |                                                           | При получении статуса 500 более 10 раз необходимо         | 
        |               |                                                           | прекратить передачу запроса. После чего передать в службу |
        |               |                                                           | техподдержки Сервис-провайдера наиболее полную информацию |
        |               |                                                           | б условиях возникновения данной ошибки для дальнейшего    |
        |               |                                                           | анализа.                                                  |
        +---------------+-----------------------------------------------------------+-----------------------------------------------------------+
        | 503           | Запрос в обработке.                                       | Партнёр должен выдержать паузу и подождать ответ на первый| 
        |               |                                                           | запрос с переданным значением параметра *partnerMsgId*.   |
        |               | Ошибка может возникнуть, если Партнёр практически         |                                                           |
        |               | одновременно передает несколько запросов с одним и тем    | Партнёр может повторить запрос, если не получит ответ на  |
        |               | же значением параметра *partnerMsgId*.                    | первый запрос.                                            |
        |               | Пока не обработан первый запрос на следующие запросы с    |                                                           |
        |               | тем же *partnerMsgId* Сервис-провайдер вернет             |                                                           |
        |               | Партнёру статус 503.                                      |                                                           |
        +---------------+-----------------------------------------------------------+-----------------------------------------------------------+


.. _WA Ответ в формате XML:

Ответ в формате XML
~~~~~~~~~~~~~~~~~~~~

| Для получения ответа в формате :abbr:`XML (Xtensible Markup Language — расширяемый язык разметки)` Партнеру в теле запроса необходимо передать параметр **output=xml**.
| В таком случае Сервис-провайдер синхронно отвечает на запрос одним из следующих HTTP-кодов:

* 200 – запрос успешно обработан;
* 500 – внутренняя ошибка сервера, технические проблемы на стороне Сервис-провайдера.

Примеры ответов
^^^^^^^^^^^^^^^^^^

.. tabs::

    .. tab:: Успешная отправка

        | Пример ответа в формате XML при успешной отправке запроса (HTTP-код **200**) .
        | Описание содержания ответа приведено во вкладке "Элементы XML".

        .. code-block::

            <?xml version="1.0" encoding="utf-8"?>
            <response>
                <code>200</code>
                <text>OK</text>
                <payload>
                    <id>4095284976</id>
                </payload>
            </response>
            


    .. tab:: Отправка с ошибкой

        Пример ответа в формате XML при ошибочной отправке запроса: неверное сочетание serviceId / pass.

        .. code-block::

            <?xml version="1.0" encoding="utf-8"?>
            <response>
                <code>401</code>
                <text>Invalid password</text>
            </response>
            

        При получении статуса **500** или при истечении тайм-аута ожидания ответа, Партнёр должен выдержать паузу минимум 1 минуту. По истечении паузы Партнёр может повторить запрос.

        .. note:: При получении статуса **500** более 10 раз необходимо прекратить передачу запроса. После чего передать в службу техподдержки Сервис-провайдера наиболее полную информацию об условиях возникновения данной ошибки для дальнейшего анализа.


    .. tab:: Описание элементов XML

        В таблице **обязательные** параметры выделены **жирным** шрифтом.

        +-----------------+--------------------------------------------------+------------------------------------------+
        | Наименование    | Описание                                         | Примечание                               |
        +=================+==================================================+==========================================+
        | **xml version** | Номер версии XML.                                | Содержится в прологе XML-документа.      |
        +-----------------+--------------------------------------------------+------------------------------------------+
        | encoding        | Кодировка.                                       | Содержится в прологе XML-документа.      |
        +-----------------+--------------------------------------------------+------------------------------------------+
        | **response**    | Корневой элемент, содержит элементы              |                                          |
        |                 | *code*, *text*, *payload*.                       |                                          |
        +-----------------+--------------------------------------------------+------------------------------------------+
        | **code**        | Код ответа (значения соответствуют HTTP-кодам    | Подробное описание этих кодов приведено  |
        |                 | для ответов с типом text/plain).                 | :ref:`выше. <Коды-ошб-при-отпр-запроса>` |
        +-----------------+--------------------------------------------------+------------------------------------------+
        | text            | Дополнительная краткая текстовая информация      | Может содержать информацию об ошибке.    |
        |                 | об ответе.                                       |                                          |
        +-----------------+--------------------------------------------------+------------------------------------------+
        | payload         | Информация о сообщении, содержит элемент *id*.   | Передаются только в случае успешного     |
        |                 |                                                  | выполнения запроса (при значении         |
        +-----------------+--------------------------------------------------+ *code=200*).                             |
        | id              | Идентификатор, присвоенный сообщению             |                                          |
        |                 | Сервис-провайдером.                              |                                          |
        |                 | Идентификатор представляет                       |                                          |
        |                 | собой 64-разрядное целое положительное число.    |                                          |
        +-----------------+--------------------------------------------------+------------------------------------------+








  
