CardsMobile
==============

Тип сообщения CardsMobile относится только к приложению “Кошелёк“.

В сообщениях типа CardsMobile доступна передача заголовка, текста и, опционально, изображения.

Отправка сообщений
-------------------------

.. tabs::

    .. tab:: Пример запроса

        .. code-block:: json
           :linenos:

            {
               "login": "Login",
               "password": "Password",
               "destAddr": "79211234567",
               "message": {
                  "type": "CARDSMOBILE",
                  "data": {
                     "text": "Hello, world!",
                     "title": "Super Title!",
                     "serviceNumber": "0000",
                     "ttl": 3600,
                     "ttlUnit": "SECONDS",
                     "content": {
                     "contentUrl": "http://ya.ru/123.jpg"
                     },
                     "target": "campaign",
                     "campaignId": "123",
                     "pushType": "PROMO"
                  }
               }
            }


    .. tab:: Параметры запроса

         **Обязательные** параметры выделены **жирным** шрифтом.

         +----------------------------------+------------------+--------------------------------------------------------------------------------+
         | Параметр                         | Тип данных       | Описание                                                                       |
         +==================================+==================+================================================================================+
         | **login**                        | string           | Имя Партнера в системе.                                                        |
         +----------------------------------+------------------+--------------------------------------------------------------------------------+
         | **password**                     | string           | Пароль Партнера в системе.                                                     |
         +----------------------------------+------------------+--------------------------------------------------------------------------------+
         | extraParam                       | string           | | Дополнительные параметры, передаваемые в виде *param1=value1,param2=value2*, |
         |                                  |                  |   где                                                                          |
         |                                  |                  |                                                                                |
         |                                  |                  | * *param1* и *param2* -- названия параметров;                                  |
         |                                  |                  | * *value1* и *value2* -- значения.                                             |
         |                                  |                  |                                                                                |
         |                                  |                  | | Символ запятой в название параметра входить не может, но может входить       |
         |                                  |                  |   в его значение -- в этом случае он должен удваиваться.                       |
         |                                  |                  | | Пример: строка место=абзаково,название=гостевой дом-2,координаты=53.8085896,,|
         |                                  |                  |   58.6362112,c=23.02.09,по=05.03.09.                                           |
         +----------------------------------+------------------+--------------------------------------------------------------------------------+
         | _`useTimeDiff`                   | boolean          | | Учитывание часового пояса при запуске рассылки.                              |
         |                                  |                  | | Если *true*, то отправка сообщения осуществляется абоненту согласно          |
         |                                  |                  |   расписанию рассылки и его часовому поясу.                                    |
         |                                  |                  | | Если *false*, то сообщение отправляется согласно расписанию инициатора       |
         |                                  |                  |   рассылки UTC+3, без учёта часового пояса получателя сообщения.               |
         |                                  |                  | | Значение по умолчанию: *false*.                                              |
         +----------------------------------+------------------+--------------------------------------------------------------------------------+
         | _`scheduleInfo`                  | object           | | Расписание рассылки. Если не указано, отправляется сразу же, в момент        |
         |                                  |                  |   получения запроса.                                                           |
         +----------------------------------+------------------+--------------------------------------------------------------------------------+
         | scheduleInfo/timeBegin           | string           | Время начала, например, «10:00».                                               |
         +----------------------------------+------------------+--------------------------------------------------------------------------------+
         | scheduleInfo/timeEnd             | string           | Время окончания, например, «21:00».                                            |
         +----------------------------------+------------------+--------------------------------------------------------------------------------+
         | scheduleInfo/weekdaysSchedule    | string           | | Дни рассылки. Задаются цифрами от 1 (понедельник) до 7 (воскресение),        |
         |                                  |                  |   например, «12345».                                                           |
         |                                  |                  | | Если ограничений по дням недели нет, то данный параметр может быть пустой    |
         |                                  |                  |   или не передан в запросе.                                                    |
         +----------------------------------+------------------+--------------------------------------------------------------------------------+
         | scheduleInfo/deadline            | string           | Дата окончания рассылки, например, *2024-09-10T16:29:30+0300*.                 |
         +----------------------------------+------------------+--------------------------------------------------------------------------------+
         | _`id`                            | string           | | Уникальный идентификатор на стороне Партнёра.                                |
         |                                  |                  |   Данный параметр нужен для  контроля повторных отправок и дублирования        |
         |                                  |                  |   (сервис контроля включается отдельно).                                       |
         |                                  |                  | | Партнёр может вызывать Сервис-провайдера (запрос на отправку сообщения)      |
         |                                  |                  |   с одним и тем же id несколько раз. При этом: отправка сообщения абоненту     |
         |                                  |                  |   будет выполнена только один раз (по первому запросу).                        |
         |                                  |                  | | В ответах на запросы Сервис-провайдер вернет Партнёру один и тот же          |
         |                                  |                  |   идентификатор сообщения в системе Сервис-провайдера (тот же, что на          |
         |                                  |                  |   первый запрос).                                                              |
         |                                  |                  | | Сервис-провайдер опционально возвращает Партнёру данный идентификатор        |
         |                                  |                  |   при его наличии в отчёте о доставке сообщения.                               |
         +----------------------------------+------------------+--------------------------------------------------------------------------------+
         | _`destAddr`                      | string           | | Номер телефона абонента. Содержит код страны, код оператора и номер телефона.|
         |                                  |                  | | Для РФ код может быть '8', '7' или '+7'.                                     |
         |                                  |                  | | Примеры номеров: 72101234567, +72101234567, 8-210-123-45-67, 82101234567.    |
         +----------------------------------+------------------+--------------------------------------------------------------------------------+
         | **message**                      | object           | Параметры отправляемого сообщения.                                             |
         +----------------------------------+------------------+--------------------------------------------------------------------------------+
         | **message/type**                 | enum             | Тип сообщения. Передается значение *CARDSMOBILE*.                              |
         +----------------------------------+------------------+--------------------------------------------------------------------------------+
         | **message/data**                 | object           | Параметры отправляемых данных.                                                 |
         +----------------------------------+------------------+--------------------------------------------------------------------------------+
         | *message/data/ttl*               | integer          | | Срок жизни сообщения. Допустимый диапазон, секунд: от 30 до 86400.           |
         |                                  |                  | | Примечания. При *ttl = 0* или отсутствии параметра в запросе берётся значение|
         |                                  |                  |   из настроек по умолчанию, которые задаются при настройке интеграции отдельно |
         |                                  |                  |   для каждого клиента.                                                         |
         |                                  |                  | | Если *ttl* не указан в данных местах, то запрос будет отклонён               |
         |                                  |                  |   системой и будет выведена ошибка.                                            |
         +----------------------------------+------------------+--------------------------------------------------------------------------------+
         | message/data/ttlUnit             | enum             | | Единица измерения периода доставки сообщения. Передается только вместе       |
         |                                  |                  |   с *ttl*.                                                                     |
         |                                  |                  | | Допустимые значения:                                                         |
         |                                  |                  |                                                                                |
         |                                  |                  | * SECONDS;                                                                     |
         |                                  |                  | * MINUTES;                                                                     |
         |                                  |                  | * HOURS.                                                                       |
         +----------------------------------+------------------+--------------------------------------------------------------------------------+
         | **message/data/serviceNumber**   | string           | | Сервисное имя, от которого осуществляется отправка сообщения.                |
         |                                  |                  | | Для сообщений с типом CardsMobile данный параметр не является обязательным.  |
         |                                  |                  | | Если в запросе данный параметр не передан, то берется значение из настроек   |
         |                                  |                  |   интеграции.                                                                  |
         |                                  |                  | | Также, если в настройках нет значения данного параметра,                     |
         |                                  |                  |   то будет использоваться сервисное имя “CARDSMOBILE“.                         |
         +----------------------------------+------------------+--------------------------------------------------------------------------------+
         | **message/data/text**            | string           | Текст отправляемого сообщения. Количество символов, не более: 150.             |
         +----------------------------------+------------------+--------------------------------------------------------------------------------+
         | **message/data/title**           | string           | Заголовок для текстового сообщения. Количество символов, не более: 50.         |
         +----------------------------------+------------------+--------------------------------------------------------------------------------+
         | message/data/target              | enum             | | Текстовая константа для сообщений с типом CardsMobile.                       |
         |                                  |                  | | Определяет экран приложения, к которому должен быть осуществлен переход      |
         |                                  |                  |   при нажатии на сообщение.                                                    |
         |                                  |                  | | Возможные значения:                                                          |
         |                                  |                  |                                                                                |
         |                                  |                  | - card — к экрану выпущенной карты;                                            |
         |                                  |                  | - campaign — к конкретной акции по выпущенной карте;                           |
         |                                  |                  | - campaigns — к полному списку акций по выпущенной карте.                      |
         |                                  |                  |                                                                                |
         |                                  |                  | Значение по умолчанию: *card*.                                                 |
         +----------------------------------+------------------+--------------------------------------------------------------------------------+
         | *message/data/campaignId*        | string           | | Текстовый идентификатор промо-акции для перехода.                            |
         |                                  |                  | | Обязателен, если *target=campaign*.                                          |
         |                                  |                  | | Указывается ID акции в системе партнера или в Личном кабинете партнера       |
         |                                  |                  |   в системе «Кошелёк для бизнеса».                                             |
         |                                  |                  | | Количество символов, не более: 128.                                          |
         +----------------------------------+------------------+--------------------------------------------------------------------------------+
         | message/data/pushType            | enum             | | Текстовая константа для сообщений с типом CardsMobile.                       |
         |                                  |                  | | Определяет тип трафика, присвоенный сообщению партнером.                     |
         |                                  |                  | | Возможные значения:                                                          |
         |                                  |                  |                                                                                |
         |                                  |                  | * PROMO – рекламный трафик;                                                    |
         |                                  |                  | * SERVICE – сервисный трафик;                                                  |
         |                                  |                  | * TRANSACTION – транзакционный трафик.                                         |
         +----------------------------------+------------------+--------------------------------------------------------------------------------+
         | message/data/content             | object           | Параметры для отправки изображений.                                            |
         +----------------------------------+------------------+--------------------------------------------------------------------------------+
         | message/data/content/            | enum             | | Категория содержимого по ссылке contentUrl.                                  |
         | contentCategory                  |                  | | Возможное значение: *IMAGE* – для передачи в *contentUrl* ссылки             |
         |                                  |                  |   на изображение.                                                              |
         +----------------------------------+------------------+--------------------------------------------------------------------------------+
         | message/data/content/contentUrl  | string           | | URL-адрес изображения. Максимальная длина ссылки, символов: 512.             |
         |                                  |                  | | Требования к изображению:                                                    |
         |                                  |                  |                                                                                |
         |                                  |                  | * форматы изображения: JPEG, PNG;                                              |
         |                                  |                  | * разрешение изображения, пикселей, не более: 1024х512.                        |
         +----------------------------------+------------------+--------------------------------------------------------------------------------+
         | registeredDelivery               | integer          | | Необходимость отчётов о доставке.                                            |
         |                                  |                  | | Возможные значения:                                                          |
         |                                  |                  |                                                                                |
         |                                  |                  | * 0 - статусы не нужны;                                                        |
         |                                  |                  | * 1 - нужны статусы (по умолчанию);                                            |
         |                                  |                  | * 2 - нужны только «Не доставлено».                                            |
         +----------------------------------+------------------+--------------------------------------------------------------------------------+
         | notifyUrl                        | string           | | Hostname входящего api для получения отчета о доставке (см.                  |
         |                                  |                  |   :doc:`rest_status`).                                                         |
         |                                  |                  | | Этот параметр в запросе необязательный, но при его отправке нужно учесть     |
         |                                  |                  |   следующее:                                                                   |
         |                                  |                  |                                                                                |
         |                                  |                  | * если парметр указан, он не может быть пустым;                                |
         |                                  |                  | * длина строки *notifyUrl* не должна превышать 2048 символов.                  |
         |                                  |                  |                                                                                |
         |                                  |                  | | При невыполнении любого из указанных условий будет сгенерирована ошибка,     |
         |                                  |                  |   запрос не будет выполнен.                                                    |
         +----------------------------------+------------------+--------------------------------------------------------------------------------+


Ответ на запрос 
-----------------

После отправки сообщения Сервис-провайдер синхронно возвращает ответ. В случае успешной отправки возвращается HTTP-code 200 OK.

Ответ при успешной отправке
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

.. tabs::

    .. tab:: Пример ответа

      .. code-block:: json
         :linenos:

           {
              "mtNum": "7390612217"
              "id": "8770599"
           }


    .. tab:: Параметры ответа

      .. csv-table:: 
          :header: "Параметр", "Тип данных", "Описание"
          :widths: 30, 15, 35
          :class: my-table

          "mtNum", "string", "Идентификатор цепочки отправки, присваиваемый платформой Сервис-провайдера."
          "id", "string", "Уникальный идентификатор на стороне Партнёра. Присутствует, если был передан при отправке."
          


Ошибки при отправке  
~~~~~~~~~~~~~~~~~~~~~~~

Для ошибочных результатов HTTP-код ответа будет отличный от 200 (см. :ref:`Коды-ошибок-отправки-CardsMobile`).

.. tabs::

   .. tab:: Пример ответа с ошибкой

      .. code-block:: json   
           :linenos:

            { 
                "error": { 
                   "code": 1, 
                   "description": "Service is unavailable" 
                }
            }



   .. tab:: Параметры ответа

      .. csv-table:: 
        :header: "Параметр", "Тип данных", "Описание"
        :widths: 30, 15, 35
        :class: my-table

        "error", "object", "Информация об ошибке."
        "error/code", "int", "Код ошибки."
        "error/description", "string", "Краткое описание ошибки."
        "extendedDescription", "string", "Подробное описание ошибки (необязательный параметр)."


.. _Коды-ошибок-отправки-CardsMobile:

Коды ошибок отправки  
~~~~~~~~~~~~~~~~~~~~~~~

.. csv-table:: 
   :header: "Код", "Описание", "HTTP-код"
   :widths: 7, 30, 15
   :class: my-table

   1, "Service is unavailable", "503"
   2, "Invalid IP-address", "403"
   3, "Too many connections", "429"
   4, "Invalid request", "400"
   5, "Invalid login", "401"
   6, "Invalid password", "401"
   7, "serviceNumber is not defined", "400"
   8, "destAddr is not correct", "406"
   9, "Message type is not correct", "406"
   10, "Prohibited sending duplicates", "409"
   11, "Invalid TTL", "406"
   100, "100", "500"
        



Статусы доставки сообщений CardsMobile
-----------------------------------------

Для получения статусов сообщений CardsMobile необходимо настроить :doc:`rest_status`.
