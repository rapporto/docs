Сервис получения статусов доставки сообщений
=============================================

Подключение сервиса
--------------------

Сервис-провайдер отправляет Партнёру отчёт о доставке сообщений, передавая его на настроенный URL для передачи статусов доставки. 

URL для передачи статусов задается в настройках интеграции при подключении сервиса, так же он может передаваться в параметре *notifyUrl.* Переданный в параметре адрес считается приоритетным, а в случае, если
параметр не передан или передан некорректный адрес, то отчет о доставке сообщений передается на заданный при настройке соединения.

Метод передачи данных: POST.


.. _REST-Статус-параметры:

Отчёт о доставке
------------------

.. tabs::

    .. tab:: Пример отчета о доставке

        .. code-block:: json
           :linenos:

            {
              "id":"8770599",
              "mtNum":"107930572",
              "status":2,
              "type":"SMS",
              "doneDate":"2019-05-05T10:20:35+0300",
              "submitDate":"2019-05-05T10:19:55+0300",
              "sourceAddr":"SOURCE",
              "destAddr": "72101234567",
              "text":"message_text",
              "partCount":"001",
              "errorCode":"0",
              "mccMnc":"25012",
              "trafficType":0
            }

    .. tab:: Параметры отчета о доставке

        +-------------+---------+--------------------------------------------+
        | id          | string  | Уникальный идентификатор на стороне        |
        |             |         | Партнёра. Если Партнёр не передал, то      |
        |             |         | значение отсутствует.                      |
        +-------------+---------+--------------------------------------------+
        | mtNum       | string  | Идентификатор цепочки отправки,            |
        |             |         | присваиваемый платформой                   |
        |             |         | Сервис-провайдера.                         |
        +-------------+---------+--------------------------------------------+
        | status      | integer | Статус доставки. Возвращает следующие      |
        |             |         | значения:                                  |
        |             |         |                                            |
        |             |         | * 0 -- отправлено в сторону Оператора,     |
        |             |         |   финальный статус пока не известен;       |
        |             |         | * 2 -- доставлено;                         |
        |             |         | * 5 -- не доставлено. Информация о причине |
        |             |         |   недоставки указана в поле errorCode;     |
        |             |         | * 9 -- прочитано (кроме FlashingCall, SMS).|
        +-------------+---------+--------------------------------------------+
        | type        | string  | Тип сообщения: SMS, VIBER, VK, PUSH,       |
        |             |         | WHATSAPP, TELEGRAM, FLASHINGCALL.          |
        +-------------+---------+--------------------------------------------+
        | doneDate    | date    | Дата/время доставки. Если не доставлено,   |
        |             |         | то пусто.                                  |
        +-------------+---------+--------------------------------------------+
        | submitDate  | date    | Дата/время отправки сообщения.             |
        +-------------+---------+--------------------------------------------+
        | destAddr    | string  | Номер абонента.                            |
        +-------------+---------+--------------------------------------------+
        | sourceAddr  | string  | Сервисный номер, с которого была           |
        |             |         | осуществлена отправка сообщения.           |
        +-------------+---------+--------------------------------------------+
        | text        | string  | Текст сообщения.                           |
        +-------------+---------+--------------------------------------------+
        | partCount   | string  | Количество частей сообщения.               |
        +-------------+---------+--------------------------------------------+
        | errorCode   | string  | Код ошибки.                                |
        |             |         |                                            |
        |             |         | Параметр errorCode при успешном выполнении |
        |             |         | отправки равен 0.                          |
        |             |         | При status = 5 возвращает код ошибки.      |
        |             |         | Набор кодов зависит от типа сообщения.     |
        |             |         | Описание кодов приведено ниже.             |
        +-------------+---------+--------------------------------------------+
        | mccMnc      | string  | MCC и MNC коды. Параметр содержит MCC-код, |
        |             |         | который, как правило, состоит из трёх цифр,|
        |             |         | и MNC-код из двух цифр.                    |
        |             |         | Передаётся опционально.                    |
        +-------------+---------+--------------------------------------------+
        | trafficType | integer | Тип трафика. Возвращает тип трафика:       |
        |             |         |                                            |
        |             |         | -  0 – рекламный;                          |
        |             |         | -  1 – транзакционный;                     |
        |             |         | -  2 – сервисный;                          |
        |             |         | -  5 – информационный;                     |
        |             |         | -  6 – авторизационный;                    |
        |             |         | -  7 – рекламный шаблонируемый.            |
        +-------------+---------+--------------------------------------------+


Статусы доставки
-----------------

.. csv-table:: 
    :header: "Код", "Статус доставки", "Описание"
    :widths: 7, 15, 30
    :class: my-table

     0, "Отправлено (SEND)", "Отправлено в сторону Оператора, финальный статус пока не известен."
     2, "Доставлено (DELIVERED)", "Доставлено оператору, после доставки возможно ожидание статуса о прочтении абонентом."
     5, "Не доставлено (UNDELIVERED, REJECTED)", "Отклонено оператором/не доставлено оператору. Информация о причине недоставки указана в поле параметров доставки *errorCode*. Финальный статус, далее других статусов не ожидается."
     9, "Прочитано (READ)", "Статус о прочтении сообщения абонентом.  *Для всех сообщений, кроме FlashingCall и SMS*. Финальный статус, далее других статусов не ожидается."


Описание кодов ошибок (параметр *errorCode=5*)
-----------------------------------------------

В разделе приведено описание причин недоставки сообщений разных типов.

.. tabs::


    .. tab:: Push

      +---------+----------------------------+-----------------------------+
      | Код     | Наименование ошибки        | Описание ошибки             |
      +=========+============================+=============================+
      | 1       | unknown                    | В процессе доставки         |
      |         |                            | сообщения произошла         |
      |         |                            | неизвестная платформе       |
      |         |                            | ошибка, либо оператор не    |
      |         |                            | предоставил ошибку в        |
      |         |                            | отчете о доставке.          |
      +---------+----------------------------+-----------------------------+
      | 7       | timeout                    | Коммутационное оборудование,|
      |         |                            | на котором зарегистрирован  |
      |         |                            | абонент, не отвечает.       |
      +---------+----------------------------+-----------------------------+
      | 8       | unknown-subscriber         | Некорректный номер абонента,|
      |         |                            | либо телефон абонента был   |
      |         |                            | выключен на протяжении очень|
      |         |                            | долгого периода времени.    |
      +---------+----------------------------+-----------------------------+
      | 9       | duplicated                 | Сообщение было отброшено    |
      |         |                            | платформой, так как         |
      |         |                            | сработал механизм отсечения |
      |         |                            | дубликатов сообщений.       |
      +---------+----------------------------+-----------------------------+
      | 11      | unrouted                   | Ошибка маршрутизации в      |
      |         |                            | конфигурации платформы.     |
      +---------+----------------------------+-----------------------------+
      | 13      | oper-invsrcaddr            | Отправка сообщения с        |
      |         |                            | незарегистрированного у     |
      |         |                            | оператора имени отправителя.|
      +---------+----------------------------+-----------------------------+
      | 18      | bad-params                 | Указаны неверные параметры  |
      |         |                            | запроса или не указаны      |
      |         |                            | обязательные параметры.     |
      +---------+----------------------------+-----------------------------+
      | 19      | consumer-id-not-found      | Не найдена карточка с       |
      |         |                            | передаваемым идентификатором|
      |         |                            | абонента.                   |
      +---------+----------------------------+-----------------------------+
      | 20      | consumer-phone-not-found   | Не найдена карточка с       |
      |         |                            | передаваемым номером        |
      |         |                            | телефона абонента.          |
      +---------+----------------------------+-----------------------------+
      | 21      | no-primary-devices         | Устройство не является      |
      |         |                            | основным. В случае, если    |
      |         |                            | была выполнена отправка     |
      |         |                            | на основное утройство       |
      |         |                            | (primaryOn=true).           |      
      +---------+----------------------------+-----------------------------+
      | 22      | no-active-installations    | Не найдено активных         |
      |         |                            | установок мобильного        |
      |         |                            | приложения на устройстве    |
      |         |                            | пользователя.               |
      +---------+----------------------------+-----------------------------+
      | 23      | push-disabled              | У пользователя мобильного   |
      |         |                            | приложения установлен       |
      |         |                            | запрет на получение         |
      |         |                            | push-уведомлений на уровне  |
      |         |                            | приложения.                 |
      +---------+----------------------------+-----------------------------+
      | 24      | push-os-disabled           | У пользователя мобильного   |
      |         |                            | приложения установлен       |
      |         |                            | запрет на получение         |
      |         |                            | push-уведомлений на уровне  |
      |         |                            | операционной системы.       |
      +---------+----------------------------+-----------------------------+
      | 25      | subscription-failed        | При отправке сообщения      |
      |         |                            | были указаны подписки,      |
      |         |                            | которые не настроены        |
      |         |                            | на установке мобильного     |
      |         |                            | приложения пользователя.    |
      +---------+----------------------------+-----------------------------+
      | 26      | no-application             | Не найдена установка        |
      |         |                            | мобильного приложения       |
      |         |                            | на устройстве пользователя. |
      +---------+----------------------------+-----------------------------+  
      | 27      | below-min-version          | Версия приложения меньше    |
      |         |                            | минимально допустимой       |
      |         |                            | версии. В текущей реализации|
      |         |                            | актуально только для IOS.   |   
      +---------+----------------------------+-----------------------------+
      | 28      | provider-error             | Облачный провайдер          |
      |         |                            | (APNS, FCM или HMS),        |
      |         |                            | через которого выполняется  |
      |         |                            | отправка уведомления,       |
      |         |                            | вернул ошибку.              |
      +---------+----------------------------+-----------------------------+


    .. tab:: SMS

      +---------+----------------------------+----------------------------+
      | Код     | Наименование ошибки        | Описание ошибки            |
      +=========+============================+============================+
      | 1       | unknown                    | В процессе доставки        |
      |         |                            | сообщения произошла        |
      |         |                            | неизвестная платформе      |
      |         |                            | ошибка, либо оператор не   |
      |         |                            | предоставил ошибку в       |
      |         |                            | отчете о доставке.         |
      +---------+----------------------------+----------------------------+
      | 2       | absent-subscriber          | Аппарат абонента был       |
      |         |                            | выключен или находился вне |
      |         |                            | зоны действия сети на      |
      |         |                            | протяжении всего времени   |
      |         |                            | попыток доставки           |
      |         |                            | сообщения.                 |
      +---------+----------------------------+----------------------------+
      | 3       | call-barred                | Аппарат абонента           |
      |         |                            | заблокирован, либо у       |
      |         |                            | абонента включен запрет на |
      |         |                            | прием сообщений, либо      |
      |         |                            | абонент находится в        |
      |         |                            | роуминге с включенным      |
      |         |                            | запретом на прием          |
      |         |                            | сообщений в роуминге.      |
      +---------+----------------------------+----------------------------+
      | 4       | failure                    | В процессе доставки        |
      |         |                            | сообщения произошла ошибка |
      |         |                            | на транспортном уровне     |
      |         |                            | сигнальной сети.           |
      +---------+----------------------------+----------------------------+
      | 5       | memory-capacity-exceeded   | Память телефона абонента   |
      |         |                            | переполнена.               |
      +---------+----------------------------+----------------------------+
      | 6       |teleservice-not-provisioned | У абонента не подключена   |
      |         |                            | услуга приема сообщений.   |
      +---------+----------------------------+----------------------------+
      | 7       | timeout                    | Коммутационное             |
      |         |                            | оборудование, на котором   |
      |         |                            | зарегистрирован абонент,   |
      |         |                            | не отвечает.               |
      +---------+----------------------------+----------------------------+
      | 8       | unknown-subscriber         | Некорректный номер         |
      |         |                            | абонента, либо телефон     |
      |         |                            | абонента был выключен на   |
      |         |                            | протяжении очень долгого   |
      |         |                            | периода времени.           |
      +---------+----------------------------+----------------------------+
      | 9       | duplicated                 | Сообщение было отброшено   |
      |         |                            | платформой, так как        |
      |         |                            | сработал механизмом        |
      |         |                            | отсечения дубликатов       |
      |         |                            | сообщений.                 |
      +---------+----------------------------+----------------------------+
      | 10      | filtered                   | Сообщение было отброшено   |
      |         |                            | платформой, так как        |
      |         |                            | сработал один из фильтров  |
      |         |                            | сообщений, например,       |
      |         |                            | спам-фильтр.               |
      +---------+----------------------------+----------------------------+
      | 11      | unrouted                   | Ошибка маршрутизации в     |
      |         |                            | конфигурации платформы.    |
      +---------+----------------------------+----------------------------+
      | 12      | oper-blacklisted           | Номер абонента находится в |
      |         |                            | чёрном списке оператора.   |
      +---------+----------------------------+----------------------------+
      | 13      | oper-invsrcaddr            | Отправка сообщения с       |
      |         |                            | незарегистрированного у    |
      |         |                            | оператора имени            |
      |         |                            | отправителя.               |
      +---------+----------------------------+----------------------------+
      | 14      | oper-spamfiltered          | На стороне оператора       |
      |         |                            | сработал СПАМ-фильтр по    |
      |         |                            | тексту сообщения.          |
      +---------+----------------------------+----------------------------+


    .. tab:: Telegram

      +---------+-----------------------------+----------------------------+
      | Код     | Наименование ошибки         | Описание ошибки            |
      +=========+=============================+============================+
      | 1       | unknown                     | В процессе доставки        |
      |         |                             | сообщения произошла        |
      |         |                             | неизвестная платформе      |
      |         |                             | ошибка, либо оператор не   |
      |         |                             | предоставил ошибку в       |
      |         |                             | отчете о доставке.         |
      +---------+-----------------------------+----------------------------+


    .. tab:: Viber

      +---------+------------------------------+----------------------------+
      | Код     | Наименование ошибки          | Описание ошибки            |
      +=========+==============================+============================+
      | 1       | unknown                      | В процессе доставки        |
      |         |                              | сообщения произошла        |
      |         |                              | неизвестная платформе      |
      |         |                              | ошибка, либо оператор не   |
      |         |                              | предоставил ошибку в       |
      |         |                              | отчете о доставке.         |
      +---------+------------------------------+----------------------------+
      | 2       | absent-subscriber            | Аппарат абонента был       |
      |         |                              | выключен или находился вне |
      |         |                              | зоны действия сети на      |
      |         |                              | протяжении всего времени   |
      |         |                              | попыток доставки           |
      |         |                              | сообщения.                 |      
      +---------+------------------------------+----------------------------+
      | 3       | call-barred                  | Аппарат абонента           |
      |         |                              | заблокирован, либо у       |
      |         |                              | абонента включен запрет на |
      |         |                              | прием сообщений, либо      |
      |         |                              | абонент находится в        |
      |         |                              | роуминге с включенным      |
      |         |                              | запретом на прием          |
      |         |                              | сообщений в роуминге.      |
      +---------+------------------------------+----------------------------+
      | 5       | memory-capacity-exceeded     | Память телефона абонента   |
      |         |                              | переполнена.               |
      +---------+------------------------------+----------------------------+
      | 6       | teleservice-not-provisioned  | У абонента не подключена   |
      |         |                              | услуга приема сообщений.   |
      +---------+------------------------------+----------------------------+
      | 7       | timeout                      | Коммутационное             |
      |         |                              | оборудование, на котором   |
      |         |                              | зарегистрирован абонент,   |
      |         |                              | не отвечает.               |
      +---------+------------------------------+----------------------------+
      | 9       | duplicated                   | Сообщение было отброшено   |
      |         |                              | платформой, так как        |
      |         |                              | сработал механизмом        |
      |         |                              | отсечения дубликатов       |
      |         |                              | сообщений.                 |
      +---------+------------------------------+----------------------------+
      | 11      | unrouted                     | Ошибка маршрутизации в     |
      |         |                              | конфигурации платформы.    |
      +---------+------------------------------+----------------------------+


    .. tab:: VK

      +---------+-----------------------------+----------------------------+
      | Код     | Наименование ошибки         | Описание ошибки            |
      +=========+=============================+============================+
      | 1       | unknown                     | В процессе доставки        |
      |         |                             | сообщения произошла        |
      |         |                             | неизвестная платформе      |
      |         |                             | ошибка, либо оператор не   |
      |         |                             | предоставил ошибку в       |
      |         |                             | отчете о доставке.         |
      +---------+-----------------------------+----------------------------+
      | 3       | call-barred                 | Аппарат абонента           |
      |         |                             | заблокирован, либо у       |
      |         |                             | абонента включен запрет на |
      |         |                             | прием сообщений, либо      |
      |         |                             | абонент находится в        |
      |         |                             | роуминге с включенным      |
      |         |                             | запретом на прием          |
      |         |                             | сообщений в роуминге.      |
      +---------+-----------------------------+----------------------------+
      | 6       |teleservice-not-provisioned  | У абонента не подключена   |
      |         |                             | услуга приема сообщений.   |
      +---------+-----------------------------+----------------------------+
      | 10      | filtered                    | Сообщение было отброшено   |
      |         |                             | платформой, так как        |
      |         |                             | сработал один из фильтров  |
      |         |                             | сообщений, например,       |
      |         |                             | спам-фильтр.               |
      +---------+-----------------------------+----------------------------+
      | 11      | unrouted                    | Ошибка маршрутизации в     |
      |         |                             | конфигурации платформы.    |
      +---------+-----------------------------+----------------------------+


    .. tab:: WhatsApp

      +---------+------------------------------+----------------------------+
      | Код     | Наименование ошибки          | Описание ошибки            |
      +=========+==============================+============================+
      | 3       | call-barred                  | Аппарат абонента           |
      |         |                              | заблокирован, либо у       |
      |         |                              | абонента включен запрет на |
      |         |                              | прием сообщений, либо      |
      |         |                              | абонент находится в        |
      |         |                              | роуминге с включенным      |
      |         |                              | запретом на прием          |
      |         |                              | сообщений в роуминге.      |
      +---------+------------------------------+----------------------------+
      | 6       | teleservice-not-provisioned  | У абонента не подключена   |
      |         |                              | услуга приема сообщений.   |
      +---------+------------------------------+----------------------------+
      | 7       | timeout                      | Коммутационное             |
      |         |                              | оборудование, на котором   |
      |         |                              | зарегистрирован абонент,   |
      |         |                              | не отвечает.               |
      +---------+------------------------------+----------------------------+
      |10       | filtered                     | Сообщение было отброшено   |
      |         |                              | платформой, так как        |
      |         |                              | сработал один из фильтров  |
      |         |                              | сообщений, например,       |
      |         |                              | спам-фильтр.               |
      +---------+------------------------------+----------------------------+



    .. tab:: FlashingCall (VoiceCode)

      +---------+------------------------------+----------------------------+
      | Код     | Наименование ошибки          | Описание ошибки            |
      +=========+==============================+============================+
      | 1       | unknown                      | В процессе доставки        |
      |         |                              | сообщения произошла        |
      |         |                              | неизвестная платформе      |
      |         |                              | ошибка, либо оператор не   |
      |         |                              | предоставил ошибку в       |
      |         |                              | отчете о доставке.         |
      +---------+------------------------------+----------------------------+
      | 4       | failure                      | В процессе доставки        |
      |         |                              | сообщения произошла        |
      |         |                              | ошибка на транспортном     |
      |         |                              | уровне сигнальной сети.    |
      +---------+------------------------------+----------------------------+
      | 6       | teleservice-not-provisioned  | У абонента не подключена   |
      |         |                              | услуга приема сообщений.   |
      +---------+------------------------------+----------------------------+
      | 16      | busy                         | Номер абонента занят.      |
      +---------+------------------------------+----------------------------+



    .. tab:: CardsMobile

      +---------+----------------------------+----------------------------+
      | Код     | Наименование ошибки        | Описание ошибки            |
      +=========+============================+============================+
      | 1       | unknown                    | В процессе доставки        |
      |         |                            | сообщения произошла        |
      |         |                            | неизвестная платформе      |
      |         |                            | ошибка, либо оператор не   |
      |         |                            | предоставил ошибку в       |
      |         |                            | отчете о доставке.         |
      +---------+----------------------------+----------------------------+
      | 3       | call-barred                | Аппарат абонента           |
      |         |                            | заблокирован, либо у       |
      |         |                            | абонента включен запрет на |
      |         |                            | прием сообщений, либо      |
      |         |                            | абонент находится в        |
      |         |                            | роуминге с включенным      |
      |         |                            | запретом на прием          |
      |         |                            | сообщений в роуминге.      |
      +---------+----------------------------+----------------------------+
      | 8       | unknown-subscriber         | Некорректный номер         |
      |         |                            | абонента, либо телефон     |
      |         |                            | абонента был выключен на   |
      |         |                            | протяжении очень долгого   |
      |         |                            | периода времени.           |
      +---------+----------------------------+----------------------------+


