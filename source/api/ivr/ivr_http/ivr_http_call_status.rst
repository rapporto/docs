Получение данных о выполнении звонка
===========================================

.. _IVR-HTTP-Опросная-схема: 

Опросная схема
----------------

| Партнер имеет возможность запросить информацию о статусе ранее сделанного запроса на отправку IVR-сообщения. 
| Для этого следут сделать на соответствующий URL HTTP GET-запрос с параметром *request_id* (идентификатор сообщения, ранее полученный в ответе на запрос на отправку). 
| Ответ вернется в XML-формате. 

Ответ при успешно выполненном звонке
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

На успешный запрос Сервис-провайдер возвращает Партнёру ответ со статусом *status=processed*, что означает, что вызов был успешно обработан. 
Ответ также содержит информацию о вызове, включая его статус, время, продолжительность, введенные коды и количество вызовов.

.. tabs::

    .. tab:: Пример ответа

        .. code-block:: XML

            <?xml version="1.0" encoding="utf-8"?>
            <response>
                <status>Processed</status>
                <call_time>2024-06-01 09:00:00</call_time>
                <duration>20</duration>
                <dtmf_codes>12#</dtmf_codes>
                <call_count>1</call_count>
            </response>



    .. tab:: Описание параметров

        +---------------+---------------------------------------------------------------------------+
        | Параметр      | Описание                                                                  |
        +===============+===========================================================================+
        | status        | Статус вызова.  Возможные значения:                                       |
        |               |                                                                           |
        |               | * New — вызов запланирован к исполнению;                                  |
        |               | * Initiated — звонок инициирован;                                         |
        |               | * In progress — в процессе вызова;                                        |
        |               | * Processed — вызов завершен.                                             |
        +---------------+---------------------------------------------------------------------------+
        | call_time     | Дата, время вызова в нулевом часовом поясе (UTC+0).                       |
        +---------------+---------------------------------------------------------------------------+
        | duration      | Продолжительность вызова в секундах.                                      |
        +---------------+---------------------------------------------------------------------------+
        | dtmf          | | Последовательность нажатых абонентом тональных клавиш.                  |
        |               | | Строка, состоящая из символов {0 — 9,*,#}                               |
        +---------------+---------------------------------------------------------------------------+
        | call_count    | Количество попыток дозвона.                                               |
        +---------------+---------------------------------------------------------------------------+
        | *Если настроена нотификационная схема получения статуса доставки отправленного            |
        | SMS-сообщения, и SMS-сообщение было отправлено, добавятся параметры:*                     |
        +---------------+---------------------------------------------------------------------------+
        | sms_parts     | Количество частей отправленного сообщения.                                |
        +---------------+---------------------------------------------------------------------------+
        | mt_num        | Уникальный идентификатор отправленного SMS-сообщения на Платформе.        |
        +---------------+---------------------------------------------------------------------------+
        | delivery_state| Статус сообщения.  Возможные значения:                                    |
        |               |                                                                           |
        |               | * 1 — не доставлено;                                                      |
        |               | * 2 — отправлено (статус доставки неизвестен);                            |
        |               | * 3 — доставлено.                                                         |
        +---------------+---------------------------------------------------------------------------+
        | delivery_date | | Дата доставки сообщения.                                                |
        |               | | Этот элемент будет показан, только если сообщение находится             |
        |               |   в финальном статусе (1 или 3).                                          |
        +---------------+---------------------------------------------------------------------------+



Ответ на запрос в случае ошибки
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Если при обработке вызова возникла ошибка, Сервис-провайдер возвращает Партнёру ответ со статусом *status=error*, а также информацию о возникшей ошибке при вызове, включая статус, код и описание ошибки, а также количество вызовов, связанных с сессией.


.. tabs::

    .. tab:: Пример ответа

        .. code-block:: XML

            <?xml version="1.0" encoding="utf-8"?>
            <response>
                <status>Error</status>
                <error_code>603</error_code>
                <error>Call was rejected</error>
                <call_count>2</call_count>
            </response>



    .. tab:: Описание параметров

        +---------------+---------------------------------------------------------------------------+
        | Параметр      | Описание                                                                  |
        +===============+===========================================================================+
        | status        | Статус вызова.  Возможные значения:                                       |
        |               |                                                                           |
        |               | * Error — ошибка вызова.                                                  |
        +---------------+---------------------------------------------------------------------------+
        | error_code    | Код ошибки.                                                               |
        +---------------+---------------------------------------------------------------------------+
        | error         | Текстовое описание ошибки.                                                |
        +---------------+---------------------------------------------------------------------------+
        | call_count    | Количество попыток дозвона.                                               |
        +---------------+---------------------------------------------------------------------------+



.. _IVR-HTTP-Нотифик-схема: 

Нотификационная схема
--------------------------

| Партнер имеет возможность использовать схему уведомлений для получения информации о статусе звонка. 
| Для реализации этой схемы Партнеру необходимо предоставить Платформе URL обработчика HTTP GET-запросов. 
| Как только статус звонка будет окончательно установлен (*Processed* или *Error*), Платформа отправит GET-запрос на указанный URL, включая параметры, приведенные в таблице.

+---------------+---------------------------------------------------------------------------+
| Параметр      | Описание                                                                  |
+===============+===========================================================================+
| request_id    | Идентификатор сообщения, ранее полученный в ответе на запрос на отправку. |
+---------------+---------------------------------------------------------------------------+
| status        | Статус вызова.  Возможные значения:                                       |
|               |                                                                           |
|               | * New — вызов запланирован к исполнению;                                  |
|               | * Initiated — звонок инициирован;                                         |
|               | * In progress — в процессе вызова;                                        |
|               | * Processed — вызов завершен.                                             |
|               | * Error — ошибка вызова.                                                  |
+---------------+---------------------------------------------------------------------------+
| call_time     | Дата, время вызова в формате YYYYMMDDhhmmss.                              |
+---------------+---------------------------------------------------------------------------+
| duration      | Продолжительность вызова в секундах.                                      |
+---------------+---------------------------------------------------------------------------+
| dtmf          | | Последовательность нажатых абонентом тональных клавиш.                  |
|               | | Строка, состоящая из символов {0 — 9,*,#}                               |
+---------------+---------------------------------------------------------------------------+
| error_code    | Код ошибки в случае неуспешного вызова.                                   |
+---------------+---------------------------------------------------------------------------+
| error         | Текстовое описание ошибки в случае неуспешного вызова.                    |
+---------------+---------------------------------------------------------------------------+
| call_count    | Количество попыток дозвона.                                               |
+---------------+---------------------------------------------------------------------------+
| *Если настроена SMS нотификация, добавится параметр:*                                     |
+---------------+---------------------------------------------------------------------------+
| sms_sent      | Возможные значения:                                                       |
|               |                                                                           |
|               | * Y — если сообщение было отправлено;                                     |
|               | * N — если сообщение не было отправлено.                                  |
+---------------+---------------------------------------------------------------------------+
| *Если нотификация настроена и SMS-сообщение было отправлено, добавятся параметры:*        |
+---------------+---------------------------------------------------------------------------+
| sms_parts     | Количество частей сообщения.                                              |
+---------------+---------------------------------------------------------------------------+
| mt_num        | Уникальный идентификатор отправленного SMS-сообщения на Платформе.        |
+---------------+---------------------------------------------------------------------------+

.. note:: Нотификация будет отправлена Партнёру один раз. Если в этот момент web-сервер недоступен, произошёл сетевой сбой или возникли другие проблемы — повторной отправки статуса не произойдет.
